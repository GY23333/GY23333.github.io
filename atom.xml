<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>GuoYi的博客</title>
  
  
  <link href="https://gy23333.github.io/atom.xml" rel="self"/>
  
  <link href="https://gy23333.github.io/"/>
  <updated>2025-04-13T13:15:11.449Z</updated>
  <id>https://gy23333.github.io/</id>
  
  <author>
    <name>GuoYi</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>C getopt 命令行参数解析</title>
    <link href="https://gy23333.github.io/2025/04/13/C-getopt-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/"/>
    <id>https://gy23333.github.io/2025/04/13/C-getopt-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/</id>
    <published>2025-04-13T06:37:34.000Z</published>
    <updated>2025-04-13T13:15:11.449Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>使用 <code>getopt_long_only()</code> 解析命令行参数。</p><a id="more"></a><h1 id="选项设置"><a href="#选项设置" class="headerlink" title="选项设置"></a>选项设置</h1><h2 id="shortopts-短选项"><a href="#shortopts-短选项" class="headerlink" title="shortopts 短选项"></a><code>shortopts</code> 短选项</h2><p>字符串，指定可接受的短选项。</p><ul><li>单个字符：不带参数的选项</li><li>单个字符 + <code>:</code>：带参数的选项</li><li>单个字符 + <code>::</code>：可带也可不带参数的选项</li></ul><p>如</p><ul><li><code>ab</code>： 支持两个单选项 <code>-a</code>、<code>-b</code>，且不带参数</li><li><code>a:b</code>：支持一个带参数的选项 <code>-a value</code> 和一个不带参数的选项 <code>-b</code></li><li><code>a::b</code>：支持一个可带可不带参数的选项 <code>-a</code>、 <code>-a value</code> 和一个不带参数的选项 <code>-b</code></li></ul><h2 id="longopts-长选项"><a href="#longopts-长选项" class="headerlink" title="longopts 长选项"></a><code>longopts</code> 长选项</h2><p>option 的数组，指定可接受的长选项。<strong>需以 <code>{0,0,0,0}</code> 结尾作为结束的标志</strong>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">  <span class="comment">/* has_arg can't be an enum because some compilers complain about</span></span><br><span class="line"><span class="comment">     type mismatches in all the code that assumes it is an int.  */</span></span><br><span class="line">  <span class="keyword">int</span> has_arg;</span><br><span class="line">  <span class="keyword">int</span> *flag;</span><br><span class="line">  <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p><code>name</code>：长选项名</p></li><li><p><code>has_arg</code>：是否需要参数</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> no_argument0<span class="comment">//不需要参数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> required_argument1<span class="comment">//必选参数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> optional_argument2<span class="comment">//可选参数</span></span></span><br></pre></td></tr></table></figure></li><li><p><code>flag</code>：设置结果存储方式</p><ul><li>非 NULL 时，解析到这个长选项时会把 <code>val</code> 值放入其指向的内存</li><li>如果不需要，则设置为 NULL</li></ul></li><li><p><code>val</code>：解析返回值（<code>flag</code> 为 NULL ），或者要设置的值（<code>flag</code> 不为 NULL ）</p><ul><li><code>flag</code> 为 NULL 时，为 <code>getopt_long_only()</code> 解析选项的返回值，用于区分不同的选项，一般给不同的选项设置不同的 <code>val</code> 作为 ID。也可以设置为对应短选项的字符，用来匹配长选项和短选项</li><li><code>flag</code> 不为 NULL 时，把 <code>val</code> 值放入其指向的内存</li></ul></li></ul><h1 id="getopt-long-only"><a href="#getopt-long-only" class="headerlink" title="getopt_long_only()"></a><code>getopt_long_only()</code></h1><p>解析一个 option，返回该 option 的 id，并将这个 option 的值存入 optarg 中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getopt_long_only</span><span class="params">(<span class="keyword">int</span> ___argc, <span class="keyword">char</span> *<span class="keyword">const</span> *___argv, <span class="keyword">const</span> <span class="keyword">char</span> *__shortopts, <span class="keyword">const</span> struct option *__longopts, <span class="keyword">int</span> *__longind)</span></span></span><br></pre></td></tr></table></figure><p>输入参数：</p><ul><li><code>argc</code>、<code>argv</code>：主函数参数</li><li><code>shortopts</code>：短选项字符串</li><li><code>longopts</code>：长选项结构体数组</li><li><code>longind</code>：返回长选项在 <code>longopts</code> 中的索引值。一般只用于调试，正常情况输入 <code>NULL</code> 即可。</li></ul><p>返回值：</p><p>返回解析的这个 option 的 id</p><ul><li>如果这个 option 是短选项，返回该短选项的字符</li><li>如果这个 option 是长选项<ul><li>如果 <code>flag</code> 为 NULL，则返回 <code>val</code> 值</li><li>如果 <code>flag</code> 不为 NULL，则返回 0，并将 <code>val</code> 值放入 <code>flag</code> 指针中</li></ul></li><li>解析完毕，返回 -1</li></ul><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    CMD_OPTION_A = <span class="number">1</span>,</span><br><span class="line">    CMD_OPTION_B,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">long_opts</span>[] = &#123;</span></span><br><span class="line">    &#123;<span class="string">"help"</span>, no_argument, <span class="literal">NULL</span>, <span class="string">'h'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"option_a"</span>, required_argument, <span class="literal">NULL</span>, CMD_OPTION_A&#125;, <span class="comment">// 需设置参数的 option</span></span><br><span class="line">    &#123;<span class="string">"option_b"</span>, no_argument, <span class="literal">NULL</span>, CMD_OPTION_B&#125;,       <span class="comment">// 不设置参数的 option</span></span><br><span class="line"></span><br><span class="line">    &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print_usage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *prgname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s [OPTIONS]\n"</span>, prgname);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--help                 Help\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--option_a VALUE       Option A\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--option_b             Option B\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse_args</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> option_id;</span><br><span class="line">    <span class="keyword">char</span> *prgname = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((option_id = getopt_long_only(argc, argv, <span class="string">"h"</span>, long_opts, <span class="literal">NULL</span>)) != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (option_id)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">            print_usage(prgname);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_OPTION_A:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"option A: %s\n"</span>, optarg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_OPTION_B:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"set option_b on\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            print_usage(prgname);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    ret = parse_args(argc, argv);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"failed to parse command line parameters\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;使用 &lt;code&gt;getopt_long_only()&lt;/code&gt; 解析命令行参数。&lt;/p&gt;</summary>
    
    
    
    <category term="C/C++" scheme="https://gy23333.github.io/categories/C-C/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux网卡绑定</title>
    <link href="https://gy23333.github.io/2025/03/26/Linux%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9A/"/>
    <id>https://gy23333.github.io/2025/03/26/Linux%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9A/</id>
    <published>2025-03-25T16:36:08.000Z</published>
    <updated>2025-03-26T17:12:13.372Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>Linux NIC Bonding 技术可以将多张物理网卡或者虚拟网卡绑定为一张虚拟的逻辑网卡，从而实现网卡的冗余、带宽的扩容以及负载均衡。</p><a id="more"></a><h1 id="网卡绑定的作用"><a href="#网卡绑定的作用" class="headerlink" title="网卡绑定的作用"></a>网卡绑定的作用</h1><p>网卡绑定的作用主要有两个方面：</p><ul><li><strong>提供冗余（负载均衡）</strong>：网卡绑定最主要的作用，如下图，物理机的多张物理网卡可以上连多个交换机，将网卡绑定为一张虚拟网卡，使用该 bond 虚拟网卡，当其中一个交换机故障时，流量可以自动切换到另一个交换机与物理网卡，提供了网卡的容灾能力。</li><li><strong>提高吞吐量</strong>：由于是多张网卡进行负载均衡，bond 出来的网卡的吞吐量也得到了提升。</li></ul><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20250326005558522.png" alt="image-20250326005558522" style="zoom:50%;" /></p><h1 id="网卡绑定模式"><a href="#网卡绑定模式" class="headerlink" title="网卡绑定模式"></a>网卡绑定模式</h1><h2 id="Mode-0-—-balance-rr（轮询模式）"><a href="#Mode-0-—-balance-rr（轮询模式）" class="headerlink" title="Mode 0 — balance-rr（轮询模式）"></a>Mode 0 — balance-rr（轮询模式）</h2><p>数据包依次顺序轮询每张网卡传输，即第1个包走 eth0，下一个包就走 eth1….一直轮询下去。</p><h2 id="Mode-1-—-active-backup（主备模式）"><a href="#Mode-1-—-active-backup（主备模式）" class="headerlink" title="Mode 1 — active-backup（主备模式）"></a>Mode 1 — active-backup（主备模式）</h2><p>只有一张网卡作为主，承接流量，当主网卡宕机后，启用备网卡。</p><h2 id="Mode-2-—-balance-xor（异或模式）"><a href="#Mode-2-—-balance-xor（异或模式）" class="headerlink" title="Mode 2 — balance-xor（异或模式）"></a>Mode 2 — balance-xor（异或模式）</h2><p>基于源 MAC 和目的 MAC 的 Hash 选择网卡</p><h2 id="Mode-3-—-broadcast（广播模式）"><a href="#Mode-3-—-broadcast（广播模式）" class="headerlink" title="Mode 3 — broadcast（广播模式）"></a>Mode 3 — broadcast（广播模式）</h2><p>所有数据包在所有网卡上传输。</p><h2 id="Mode-4-—-link-aggregation（动态链接聚合）"><a href="#Mode-4-—-link-aggregation（动态链接聚合）" class="headerlink" title="Mode 4 — link aggregation（动态链接聚合）"></a>Mode 4 — link aggregation（动态链接聚合）</h2><h2 id="Mode-5-—-balance-tlb（传输负载均衡）"><a href="#Mode-5-—-balance-tlb（传输负载均衡）" class="headerlink" title="Mode 5 — balance-tlb（传输负载均衡）"></a>Mode 5 — balance-tlb（传输负载均衡）</h2><h2 id="Mode-6-—-balance-alb（适应性负载均衡）"><a href="#Mode-6-—-balance-alb（适应性负载均衡）" class="headerlink" title="Mode 6 — balance-alb（适应性负载均衡）"></a>Mode 6 — balance-alb（适应性负载均衡）</h2><h1 id="使用-nmcli-绑定网卡"><a href="#使用-nmcli-绑定网卡" class="headerlink" title="使用 nmcli 绑定网卡"></a>使用 <code>nmcli</code> 绑定网卡</h1><h2 id="绑定网卡"><a href="#绑定网卡" class="headerlink" title="绑定网卡"></a>绑定网卡</h2><ol><li><p>创建绑定网卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add <span class="built_in">type</span> bond ifname &lt;绑定网卡名&gt; mode &lt;模式&gt;</span><br></pre></td></tr></table></figure><p>例如，创建一张名为 <code>bond0</code> 的主备模式绑定网卡</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># nmcli connection add type bond ifname bond0 mode active-backup</span></span><br><span class="line">Connection <span class="string">'bond-bond0'</span> (fed29263<span class="literal">-5656</span><span class="literal">-449b</span><span class="literal">-95c8</span><span class="literal">-cf2e23432736</span>) successfully added.</span><br></pre></td></tr></table></figure><p>查看网络设备，即可看到新建的 <code>bond0</code> 网卡</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># nmcli device status</span></span><br><span class="line">DEVICE   TYPE      STATE                                  CONNECTION</span><br><span class="line">ens160   ethernet  connected                              netplan<span class="literal">-ens160</span></span><br><span class="line">ens256   ethernet  connected                              Wired connection <span class="number">1</span></span><br><span class="line">bond0    bond      connecting (getting IP configuration)  bond<span class="literal">-bond0</span></span><br><span class="line">lo       loopback  connected (externally)                 lo</span><br><span class="line">docker0  bridge    connected (externally)                 docker0</span><br></pre></td></tr></table></figure></li><li><p>添加从属网卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add <span class="built_in">type</span> bond-slave ifname &lt;从属网卡名&gt; master &lt;绑定网卡名&gt;</span><br></pre></td></tr></table></figure><p>例如，将 <code>ens160</code> 和 <code>ens256</code> 网卡绑定到 <code>bond0</code> 网卡上</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># nmcli connection add type bond-slave ifname ens160 master bond0</span></span><br><span class="line">Connection <span class="string">'bond-slave-ens160'</span> (<span class="number">021</span>cce67<span class="literal">-1440</span><span class="literal">-4d50</span><span class="literal">-a8a9</span><span class="literal">-5c7faf8a361b</span>) successfully added.</span><br><span class="line">root@ubuntu2404:/<span class="comment"># nmcli connection add type bond-slave ifname ens256 master bond0</span></span><br><span class="line">Connection <span class="string">'bond-slave-ens256'</span> (f17d7bf7<span class="literal">-4313</span><span class="literal">-4f90</span><span class="literal">-8f9c</span><span class="literal">-5c35c0ebe319</span>) successfully added.</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># nmcli connection show</span></span><br><span class="line">NAME                UUID                                  TYPE      DEVICE</span><br><span class="line">netplan<span class="literal">-ens160</span>      febc54dc<span class="literal">-e29c</span><span class="literal">-3939</span><span class="literal">-a911</span><span class="literal">-8a11855bd1c8</span>  ethernet  ens160</span><br><span class="line">Wired connection <span class="number">1</span>  ec18620e<span class="literal">-37bf</span><span class="literal">-3343</span><span class="literal">-acf5</span><span class="literal">-b57b8928465d</span>  ethernet  ens256</span><br><span class="line">bond<span class="literal">-bond0</span>          fed29263<span class="literal">-5656</span><span class="literal">-449b</span><span class="literal">-95c8</span><span class="literal">-cf2e23432736</span>  bond      bond0</span><br><span class="line">lo                  <span class="number">73</span>b7043c<span class="literal">-59f1</span><span class="literal">-42aa</span><span class="literal">-a711</span><span class="literal">-2eb721fc18b4</span>  loopback  lo</span><br><span class="line">docker0             <span class="number">5</span>fb2c927<span class="literal">-9b29</span><span class="literal">-4d43</span><span class="literal">-99ab</span><span class="literal">-09af694a8927</span>  bridge    docker0</span><br><span class="line">bond<span class="literal">-slave</span><span class="literal">-ens160</span>   <span class="number">021</span>cce67<span class="literal">-1440</span><span class="literal">-4d50</span><span class="literal">-a8a9</span><span class="literal">-5c7faf8a361b</span>  ethernet  --</span><br><span class="line">bond<span class="literal">-slave</span><span class="literal">-ens256</span>   f17d7bf7<span class="literal">-4313</span><span class="literal">-4f90</span><span class="literal">-8f9c</span><span class="literal">-5c35c0ebe319</span>  ethernet  --</span><br></pre></td></tr></table></figure></li><li><p>配置绑定网卡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify bond-bond0 ipv4.addresses 172.16.19.200&#x2F;24 ipv4.gateway 172.16.19.2 ipv4.method manual</span><br></pre></td></tr></table></figure></li><li><p>激活绑定</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection up bond-bond0</span><br></pre></td></tr></table></figure></li><li><p>激活从属网卡（可不激活，激活后会导致原本的网卡无法直接访问）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection up bond-slave-ens160</span><br><span class="line">nmcli connection up bond-slave-ens256</span><br></pre></td></tr></table></figure></li></ol><h2 id="验证网卡冗余"><a href="#验证网卡冗余" class="headerlink" title="验证网卡冗余"></a>验证网卡冗余</h2><p>按照上面步骤绑定完网卡后，可以看到多了一张网卡 bond0</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># ip a</span></span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: ens160: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast master bond0 state UP group default qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:ec:<span class="number">41</span>:a3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp2s0</span><br><span class="line"><span class="number">3</span>: ens256: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast master bond0 state UP group default qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:ec:<span class="number">41</span>:a3 brd ff:ff:ff:ff:ff:ff permaddr <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:ec:<span class="number">41</span>:ad</span><br><span class="line">    altname enp26s0</span><br><span class="line"><span class="number">4</span>: docker0: &lt;NO<span class="literal">-CARRIER</span>,BROADCAST,MULTICAST,UP&gt; mtu <span class="number">1500</span> qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">8</span>b:f0:<span class="number">0</span>f:<span class="number">5</span>a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet <span class="number">172.17</span>.<span class="number">0.1</span>/<span class="number">16</span> brd <span class="number">172.17</span>.<span class="number">255.255</span> scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">9</span>: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc noqueue state UP group default qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:ec:<span class="number">41</span>:a3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet <span class="number">172.16</span>.<span class="number">19.200</span>/<span class="number">24</span> brd <span class="number">172.16</span>.<span class="number">19.255</span> scope global noprefixroute bond0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::<span class="number">6</span>d51:ebf5:<span class="number">7</span>acc:<span class="number">83</span>ff/<span class="number">64</span> scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># nmcli connection show</span></span><br><span class="line">NAME                UUID                                  TYPE      DEVICE</span><br><span class="line">bond<span class="literal">-bond0</span>          <span class="number">1</span>d93dc92<span class="literal">-b5b8</span><span class="literal">-4710</span><span class="literal">-9f67</span><span class="literal">-2424899947e3</span>  bond      bond0</span><br><span class="line">bond<span class="literal">-slave</span><span class="literal">-ens160</span>   f75880e7<span class="literal">-977e</span><span class="literal">-4537</span><span class="literal">-84cd</span><span class="literal">-a5bc802ad32c</span>  ethernet  ens160</span><br><span class="line">bond<span class="literal">-slave</span><span class="literal">-ens256</span>   cf9838da<span class="literal">-7c22</span><span class="literal">-4066</span><span class="literal">-ba2d</span><span class="literal">-2b89d3e08f63</span>  ethernet  ens256</span><br><span class="line">lo                  <span class="number">73</span>b7043c<span class="literal">-59f1</span><span class="literal">-42aa</span><span class="literal">-a711</span><span class="literal">-2eb721fc18b4</span>  loopback  lo</span><br><span class="line">docker0             <span class="number">5</span>fb2c927<span class="literal">-9b29</span><span class="literal">-4d43</span><span class="literal">-99ab</span><span class="literal">-09af694a8927</span>  bridge    docker0</span><br><span class="line">netplan<span class="literal">-ens160</span>      febc54dc<span class="literal">-e29c</span><span class="literal">-3939</span><span class="literal">-a911</span><span class="literal">-8a11855bd1c8</span>  ethernet  --</span><br><span class="line">Wired connection <span class="number">1</span>  ec18620e<span class="literal">-37bf</span><span class="literal">-3343</span><span class="literal">-acf5</span><span class="literal">-b57b8928465d</span>  ethernet  --</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># nmcli device status</span></span><br><span class="line">DEVICE   TYPE      STATE                   CONNECTION</span><br><span class="line">bond0    bond      connected               bond<span class="literal">-bond0</span></span><br><span class="line">ens160   ethernet  connected               bond<span class="literal">-slave</span><span class="literal">-ens160</span></span><br><span class="line">ens256   ethernet  connected               bond<span class="literal">-slave</span><span class="literal">-ens256</span></span><br><span class="line">lo       loopback  connected (externally)  lo</span><br><span class="line">docker0  bridge    connected (externally)  docker0</span><br></pre></td></tr></table></figure><p>通过 bond0 网卡 IP 连接，单独关掉 ens160 或者 ens256 网卡（<code>ifconfig ens160 down</code>），连接都不会收到影响。</p><ol><li><p>恢复</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection down bond-bond0</span><br><span class="line">nmcli connection down bond-slave-ens160</span><br><span class="line">nmcli connection down bond-slave-ens256</span><br><span class="line"></span><br><span class="line">nmcli connection del bond-bond0</span><br><span class="line">nmcli connection del bond-slave-ens160</span><br><span class="line">nmcli connection del bond-slave-ens256</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux NIC Bonding 技术可以将多张物理网卡或者虚拟网卡绑定为一张虚拟的逻辑网卡，从而实现网卡的冗余、带宽的扩容以及负载均衡。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux策略路由</title>
    <link href="https://gy23333.github.io/2025/03/20/Linux%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1/"/>
    <id>https://gy23333.github.io/2025/03/20/Linux%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1/</id>
    <published>2025-03-20T15:11:01.000Z</published>
    <updated>2025-03-23T16:38:45.429Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>Linux 策略路由是一种高级路由机制。相比于传统路由，策略路由允许用户配置多张路由表，根据源地址、目的地址等选择不同路由表，提供了更灵活的路由控制能力。</p><a id="more"></a><h1 id="路由表（Routing-Table）"><a href="#路由表（Routing-Table）" class="headerlink" title="路由表（Routing Table）"></a>路由表（Routing Table）</h1><p>路由表是存储路由规则的集合，Linux 支持配置多张路由表。</p><h2 id="rt-tables-文件"><a href="#rt-tables-文件" class="headerlink" title="rt_tables 文件"></a>rt_tables 文件</h2><p><code>/etc/iproute2/rt_tables</code> 是 Linux 中用于定义路由表名称和编号映射的文件。</p><p>其中的每一行定义了一个路由表，包括其编号（1～255）和名称，编号和名称都不能重复。</p><p>Linux 发行版中，<code>/etc/iproute2/rt_tables</code> 的默认内容如下：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># cat /etc/iproute2/rt_tables</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># reserved values</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="number">255</span>     local</span><br><span class="line"><span class="number">254</span>     main</span><br><span class="line"><span class="number">253</span>     default</span><br><span class="line"><span class="number">0</span>       unspec</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># local</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#1      inr.ruhep</span></span><br></pre></td></tr></table></figure><h2 id="Linux-默认路由表"><a href="#Linux-默认路由表" class="headerlink" title="Linux 默认路由表"></a>Linux 默认路由表</h2><p>Linux 初始的默认状态下，包含下面四个路由表：</p><ul><li><p><code>local</code>表</p><ul><li>编号：255</li><li>存储本地接口地址和广播地址</li><li>内核自动维护，用户通常不需要修改</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># ip route show table local</span></span><br><span class="line">local <span class="number">127.0</span>.<span class="number">0.0</span>/<span class="number">8</span> dev lo proto kernel scope host src <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">local <span class="number">127.0</span>.<span class="number">0.1</span> dev lo proto kernel scope host src <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">broadcast <span class="number">127.255</span>.<span class="number">255.255</span> dev lo proto kernel scope link src <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">local <span class="number">172.16</span>.<span class="number">19.129</span> dev ens160 proto kernel scope host src <span class="number">172.16</span>.<span class="number">19.129</span></span><br><span class="line">local <span class="number">172.16</span>.<span class="number">19.133</span> dev ens256 proto kernel scope host src <span class="number">172.16</span>.<span class="number">19.133</span></span><br><span class="line">broadcast <span class="number">172.16</span>.<span class="number">19.255</span> dev ens160 proto kernel scope link src <span class="number">172.16</span>.<span class="number">19.129</span></span><br><span class="line">broadcast <span class="number">172.16</span>.<span class="number">19.255</span> dev ens256 proto kernel scope link src <span class="number">172.16</span>.<span class="number">19.133</span></span><br><span class="line">local <span class="number">172.17</span>.<span class="number">0.1</span> dev docker0 proto kernel scope host src <span class="number">172.17</span>.<span class="number">0.1</span></span><br><span class="line">broadcast <span class="number">172.17</span>.<span class="number">255.255</span> dev docker0 proto kernel scope link src <span class="number">172.17</span>.<span class="number">0.1</span> linkdown</span><br></pre></td></tr></table></figure></li><li><p><code>main</code>表</p><ul><li>编号：254</li><li>主路由表，传统路由使用的表</li><li>通过 <code>ip route</code> 命令配置或展示的都是此表</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># ip route show table main</span></span><br><span class="line">default via <span class="number">172.16</span>.<span class="number">19.2</span> dev ens160 proto dhcp src <span class="number">172.16</span>.<span class="number">19.129</span> metric <span class="number">100</span></span><br><span class="line">default via <span class="number">172.16</span>.<span class="number">19.2</span> dev ens256 proto dhcp src <span class="number">172.16</span>.<span class="number">19.133</span> metric <span class="number">101</span></span><br><span class="line"><span class="number">172.16</span>.<span class="number">19.0</span>/<span class="number">24</span> dev ens160 proto kernel scope link src <span class="number">172.16</span>.<span class="number">19.129</span> metric <span class="number">100</span></span><br><span class="line"><span class="number">172.16</span>.<span class="number">19.0</span>/<span class="number">24</span> dev ens256 proto kernel scope link src <span class="number">172.16</span>.<span class="number">19.133</span> metric <span class="number">101</span></span><br><span class="line"><span class="number">172.17</span>.<span class="number">0.0</span>/<span class="number">16</span> dev docker0 proto kernel scope link src <span class="number">172.17</span>.<span class="number">0.1</span> linkdown</span><br></pre></td></tr></table></figure></li><li><p><code>default</code>表</p><ul><li>编号：253</li><li>默认路由表，通常用于存储默认路由</li><li>初始时为空</li></ul></li><li><p><code>unspec</code>表</p><ul><li>编号：0</li><li>未指定路由表，用于表示未指定或无效的路由表</li></ul></li></ul><h2 id="自定义路由表"><a href="#自定义路由表" class="headerlink" title="自定义路由表"></a>自定义路由表</h2><p>修改 <code>/etc/iproute2/rt_tables</code> 文件，可添加自定义路由表。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;编号&gt;&lt;路由表名&gt;</span><br></pre></td></tr></table></figure><p>建议：编号虽然可以从 1 开始取，但是为了避免与未来系统可能保留的编号冲突，通常选择从 100 开始分配编号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100   custom1</span><br><span class="line">101   custom2</span><br></pre></td></tr></table></figure><p>也可以分段分配编号，以方便管理不同类型的路由表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100   custom1</span><br><span class="line">200   custom2</span><br></pre></td></tr></table></figure><h1 id="路由规则（Rule）"><a href="#路由规则（Rule）" class="headerlink" title="路由规则（Rule）"></a>路由规则（Rule）</h1><p>路由规则：数据包如何匹配并选择路由表的规则，根据特定的条件（如源地址、目的地址、入接口等）选择不同的路由表。</p><h2 id="查看路由规则"><a href="#查看路由规则" class="headerlink" title="查看路由规则"></a>查看路由规则</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># ip rule show</span></span><br><span class="line"><span class="number">0</span>:      from all lookup local</span><br><span class="line"><span class="number">32766</span>:  from all lookup main</span><br><span class="line"><span class="number">32767</span>:  from all lookup default</span><br></pre></td></tr></table></figure><h2 id="路由规则的组成"><a href="#路由规则的组成" class="headerlink" title="路由规则的组成"></a>路由规则的组成</h2><p>每一条路由规则包含 3 个信息：</p><ul><li>优先级：数字越小，优先级越高。自定义规则的优先级通常设置在 <strong>1 到 32765</strong> 之间。</li><li>条件：匹配数据包的条件，如源地址、目的地址、入接口等</li><li>动作：通常规定选择哪个路由表</li></ul><p>按照优先级，从小到大匹配规则，如果匹配到，则选择规定的路由表。</p><h2 id="增-删路由规则"><a href="#增-删路由规则" class="headerlink" title="增/删路由规则"></a>增/删路由规则</h2><ul><li><p>增加路由规则（优先级可缺省，缺省时取低优先级）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip rule add &lt;条件&gt; lookup &lt;表名&gt; priority &lt;优先级&gt;</span><br></pre></td></tr></table></figure></li><li><p>删除路由规则</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip rule del &lt;条件&gt; lookup &lt;表名&gt;</span><br></pre></td></tr></table></figure></li></ul><h2 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h2><p>路由规则的匹配条件支持以下字段：</p><ul><li><p>匹配数据包的源地址</p><ul><li><p><code>from &lt;PREFIX&gt;</code></p></li><li><p>示例：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来自 192.168.1.0/24 的流量使用 custom1 表</span></span><br><span class="line">ip rule add from <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span> lookup custom1</span><br></pre></td></tr></table></figure></li></ul></li><li><p>匹配数据包的目的地址</p><ul><li><p><code>to &lt;PREFIX&gt;</code></p></li><li><p>示例：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 去往 8.8.8.8 的流量使用 custom2 表</span></span><br><span class="line">ip rule add to <span class="number">8.8</span>.<span class="number">8.8</span> lookup custom2</span><br></pre></td></tr></table></figure></li></ul></li><li><p>匹配数据包的入网卡</p><ul><li><p><code>iif &lt;网卡&gt;</code></p></li><li><p>示例：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 eth1 接口进入的流量使用 custom3 表</span></span><br><span class="line">ip rule add iif eth1 lookup custom3</span><br></pre></td></tr></table></figure></li></ul></li><li><p>匹配数据包的协议</p><ul><li><p><code>ipproto &lt;PROTOCOL&gt;</code></p></li><li><p>示例：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP 协议的流量使用 custom4 表</span></span><br><span class="line">ip rule add proto tcp lookup custom4</span><br></pre></td></tr></table></figure></li></ul></li><li><p>等等，详细见 help</p></li></ul><h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># ip rule help</span></span><br><span class="line">Usage: ip rule &#123; add | del &#125; SELECTOR ACTION</span><br><span class="line">       ip rule &#123; flush | save | restore &#125;</span><br><span class="line">       ip rule [ <span class="type">list</span> [ <span class="type">SELECTOR</span> ]]</span><br><span class="line">SELECTOR := [ <span class="type">not</span> ] [ <span class="type">from</span> <span class="type">PREFIX</span> ] [ <span class="type">to</span> <span class="type">PREFIX</span> ] [ <span class="type">tos</span> <span class="type">TOS</span> ]</span><br><span class="line">            [ <span class="type">fwmark</span> <span class="type">FWMARK</span>[/<span class="type">MASK</span>] ]</span><br><span class="line">            [ <span class="type">iif</span> <span class="built_in">STRING</span> ] [ <span class="type">oif</span> <span class="built_in">STRING</span> ] [ <span class="type">pref</span> <span class="type">NUMBER</span> ] [ <span class="type">l3mdev</span> ]</span><br><span class="line">            [ <span class="type">uidrange</span> <span class="type">NUMBER</span>-<span class="type">NUMBER</span> ]</span><br><span class="line">            [ <span class="type">ipproto</span> <span class="type">PROTOCOL</span> ]</span><br><span class="line">            [ <span class="type">sport</span> [ <span class="type">NUMBER</span> | <span class="type">NUMBER</span>-<span class="type">NUMBER</span> ]</span><br><span class="line">            [ <span class="type">dport</span> [ <span class="type">NUMBER</span> | <span class="type">NUMBER</span>-<span class="type">NUMBER</span> ] ]</span><br><span class="line"><span class="type">ACTION</span> := [ <span class="type">table</span> <span class="type">TABLE_ID</span> ]</span><br><span class="line">          [ <span class="type">protocol</span> <span class="type">PROTO</span> ]</span><br><span class="line">          [ <span class="type">nat</span> <span class="type">ADDRESS</span> ]</span><br><span class="line">          [ <span class="type">realms</span> [<span class="type">SRCREALM</span>/]<span class="type">DSTREALM</span> ]</span><br><span class="line">          [ <span class="type">goto</span> <span class="type">NUMBER</span> ]</span><br><span class="line">          <span class="type">SUPPRESSOR</span></span><br><span class="line"><span class="type">SUPPRESSOR</span> := [ <span class="type">suppress_prefixlength</span> <span class="type">NUMBER</span> ]</span><br><span class="line">              [ <span class="type">suppress_ifgroup</span> <span class="type">DEVGROUP</span> ]</span><br><span class="line"><span class="type">TABLE_ID</span> := [ <span class="type">local</span> | <span class="type">main</span> | <span class="type">default</span> | <span class="type">NUMBER</span> ]</span><br></pre></td></tr></table></figure><h1 id="路由（Route）"><a href="#路由（Route）" class="headerlink" title="路由（Route）"></a>路由（Route）</h1><p>每张路由表里都可以配置自己的路由。</p><h2 id="ip-route-命令"><a href="#ip-route-命令" class="headerlink" title="ip route 命令"></a><code>ip route</code> 命令</h2><p><code>ip route</code> 命令如果没有指定路由表，则默认指定 <code>main</code> 表。</p><h3 id="查看路由表"><a href="#查看路由表" class="headerlink" title="查看路由表"></a>查看路由表</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route show table &lt;路由表名&gt;</span><br></pre></td></tr></table></figure><h2 id="help-1"><a href="#help-1" class="headerlink" title="help"></a>help</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/<span class="comment"># ip route help</span></span><br><span class="line">Usage: ip route &#123; list | flush &#125; SELECTOR</span><br><span class="line">       ip route save SELECTOR</span><br><span class="line">       ip route restore</span><br><span class="line">       ip route showdump</span><br><span class="line">       ip route get [ <span class="type">ROUTE_GET_FLAGS</span> ] ADDRESS</span><br><span class="line">                            [ <span class="type">from</span> <span class="type">ADDRESS</span> <span class="type">iif</span> <span class="built_in">STRING</span> ]</span><br><span class="line">                            [ <span class="type">oif</span> <span class="built_in">STRING</span> ] [ <span class="type">tos</span> <span class="type">TOS</span> ]</span><br><span class="line">                            [ <span class="type">mark</span> <span class="type">NUMBER</span> ] [ <span class="type">vrf</span> <span class="type">NAME</span> ]</span><br><span class="line">                            [ <span class="type">uid</span> <span class="type">NUMBER</span> ] [ <span class="type">ipproto</span> <span class="type">PROTOCOL</span> ]</span><br><span class="line">                            [ <span class="type">sport</span> <span class="type">NUMBER</span> ] [ <span class="type">dport</span> <span class="type">NUMBER</span> ]</span><br><span class="line">       ip route &#123; add | del | change | append | replace &#125; ROUTE</span><br><span class="line">SELECTOR := [ <span class="type">root</span> <span class="type">PREFIX</span> ] [ <span class="type">match</span> <span class="type">PREFIX</span> ] [ <span class="type">exact</span> <span class="type">PREFIX</span> ]</span><br><span class="line">            [ <span class="type">table</span> <span class="type">TABLE_ID</span> ] [ <span class="type">vrf</span> <span class="type">NAME</span> ] [ <span class="type">proto</span> <span class="type">RTPROTO</span> ]</span><br><span class="line">            [ <span class="type">type</span> <span class="type">TYPE</span> ] [ <span class="type">scope</span> <span class="type">SCOPE</span> ]</span><br><span class="line">ROUTE := NODE_SPEC [ <span class="type">INFO_SPEC</span> ]</span><br><span class="line">NODE_SPEC := [ <span class="type">TYPE</span> ] PREFIX [ <span class="type">tos</span> <span class="type">TOS</span> ]</span><br><span class="line">             [ <span class="type">table</span> <span class="type">TABLE_ID</span> ] [ <span class="type">proto</span> <span class="type">RTPROTO</span> ]</span><br><span class="line">             [ <span class="type">scope</span> <span class="type">SCOPE</span> ] [ <span class="type">metric</span> <span class="type">METRIC</span> ]</span><br><span class="line">             [ <span class="type">ttl</span>-<span class="type">propagate</span> &#123; <span class="type">enabled</span> | <span class="type">disabled</span> &#125; ]</span><br><span class="line">INFO_SPEC := &#123; NH | nhid ID &#125; OPTIONS FLAGS [ <span class="type">nexthop</span> <span class="type">NH</span> ]...</span><br><span class="line">NH := [ <span class="type">encap</span> <span class="type">ENCAPTYPE</span> <span class="type">ENCAPHDR</span> ] [ <span class="type">via</span> [ <span class="type">FAMILY</span> ] <span class="type">ADDRESS</span> ]</span><br><span class="line">      [ <span class="type">dev</span> <span class="built_in">STRING</span> ] [ <span class="type">weight</span> <span class="type">NUMBER</span> ] NHFLAGS</span><br><span class="line">FAMILY := [ <span class="type">inet</span> | <span class="type">inet6</span> | <span class="type">mpls</span> | <span class="type">bridge</span> | <span class="type">link</span> ]</span><br><span class="line">OPTIONS := FLAGS [ <span class="type">mtu</span> <span class="type">NUMBER</span> ] [ <span class="type">advmss</span> <span class="type">NUMBER</span> ] [ <span class="type">as</span> [ <span class="type">to</span> ] <span class="type">ADDRESS</span> ]</span><br><span class="line">           [ <span class="type">rtt</span> <span class="type">TIME</span> ] [ <span class="type">rttvar</span> <span class="type">TIME</span> ] [ <span class="type">reordering</span> <span class="type">NUMBER</span> ]</span><br><span class="line">           [ <span class="type">window</span> <span class="type">NUMBER</span> ] [ <span class="type">cwnd</span> <span class="type">NUMBER</span> ] [ <span class="type">initcwnd</span> <span class="type">NUMBER</span> ]</span><br><span class="line">           [ <span class="type">ssthresh</span> <span class="type">NUMBER</span> ] [ <span class="type">realms</span> <span class="type">REALM</span> ] [ <span class="type">src</span> <span class="type">ADDRESS</span> ]</span><br><span class="line">           [ <span class="type">rto_min</span> <span class="type">TIME</span> ] [ <span class="type">hoplimit</span> <span class="type">NUMBER</span> ] [ <span class="type">initrwnd</span> <span class="type">NUMBER</span> ]</span><br><span class="line">           [ <span class="type">features</span> <span class="type">FEATURES</span> ] [ <span class="type">quickack</span> <span class="built_in">BOOL</span> ] [ <span class="type">congctl</span> <span class="type">NAME</span> ]</span><br><span class="line">           [ <span class="type">pref</span> <span class="type">PREF</span> ] [ <span class="type">expires</span> <span class="type">TIME</span> ] [ <span class="type">fastopen_no_cookie</span> <span class="built_in">BOOL</span> ]</span><br><span class="line">TYPE := &#123; unicast | local | broadcast | multicast | <span class="keyword">throw</span> |</span><br><span class="line">          unreachable | prohibit | blackhole | nat &#125;</span><br><span class="line">TABLE_ID := [ <span class="type">local</span> | <span class="type">main</span> | <span class="type">default</span> | <span class="type">all</span> | <span class="type">NUMBER</span> ]</span><br><span class="line">SCOPE := [ <span class="type">host</span> | <span class="type">link</span> | <span class="type">global</span> | <span class="type">NUMBER</span> ]</span><br><span class="line">NHFLAGS := [ <span class="type">onlink</span> | <span class="type">pervasive</span> ]</span><br><span class="line">RTPROTO := [ <span class="type">kernel</span> | <span class="type">boot</span> | <span class="type">static</span> | <span class="type">NUMBER</span> ]</span><br><span class="line">PREF := [ <span class="type">low</span> | <span class="type">medium</span> | <span class="type">high</span> ]</span><br><span class="line">TIME := NUMBER[<span class="type">s</span>|<span class="type">ms</span>]</span><br><span class="line">BOOL := [<span class="number">1</span>|<span class="number">0</span>]</span><br><span class="line">FEATURES := ecn</span><br><span class="line">ENCAPTYPE := [ <span class="type">mpls</span> | <span class="type">ip</span> | <span class="type">ip6</span> | <span class="type">seg6</span> | <span class="type">seg6local</span> | <span class="type">rpl</span> | <span class="type">ioam6</span> | <span class="type">xfrm</span> ]</span><br><span class="line">ENCAPHDR := [ <span class="type">MPLSLABEL</span> | <span class="type">SEG6HDR</span> | <span class="type">SEG6LOCAL</span> | <span class="type">IOAM6HDR</span> | <span class="type">XFRMINFO</span> ]</span><br><span class="line">SEG6HDR := [ <span class="type">mode</span> <span class="type">SEGMODE</span> ] segs ADDR1,ADDRi,ADDRn [<span class="type">hmac</span> <span class="type">HMACKEYID</span>] [<span class="type">cleanup</span>]</span><br><span class="line">SEGMODE := [ <span class="type">encap</span> | <span class="type">encap.red</span> | <span class="type">inline</span> | <span class="type">l2encap</span> | <span class="type">l2encap.red</span> ]</span><br><span class="line">SEG6LOCAL := action ACTION [ <span class="type">OPTIONS</span> ] [ <span class="type">count</span> ]</span><br><span class="line">ACTION := &#123; <span class="keyword">End</span> | End.X | End.T | End.DX2 | End.DX6 | End.DX4 |</span><br><span class="line">            End.DT6 | End.DT4 | End.DT46 | End.B6 | End.B6.Encaps |</span><br><span class="line">            End.BM | End.S | End.AS | End.AM | End.BPF &#125;</span><br><span class="line">OPTIONS := OPTION [ <span class="type">OPTIONS</span> ]</span><br><span class="line">OPTION := &#123; flavors FLAVORS | srh SEG6HDR | nh4 ADDR | nh6 ADDR | iif DEV | oif DEV |</span><br><span class="line">            table TABLEID | vrftable TABLEID | endpoint PROGNAME &#125;</span><br><span class="line">FLAVORS := &#123; FLAVOR[,<span class="type">FLAVOR</span>] &#125;</span><br><span class="line">FLAVOR := &#123; psp | usp | usd | next<span class="literal">-csid</span> &#125;</span><br><span class="line">IOAM6HDR := trace prealloc type IOAM6_TRACE_TYPE ns IOAM6_NAMESPACE size IOAM6_TRACE_SIZE</span><br><span class="line">XFRMINFO := if_id IF_ID [ <span class="type">link_dev</span> <span class="type">LINK</span> ]</span><br><span class="line">ROUTE_GET_FLAGS := [ <span class="type">fibmatch</span> ]</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux 策略路由是一种高级路由机制。相比于传统路由，策略路由允许用户配置多张路由表，根据源地址、目的地址等选择不同路由表，提供了更灵活的路由控制能力。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>堆</title>
    <link href="https://gy23333.github.io/2025/01/16/%E5%A0%86/"/>
    <id>https://gy23333.github.io/2025/01/16/%E5%A0%86/</id>
    <published>2025-01-15T17:41:45.000Z</published>
    <updated>2025-01-19T16:48:44.084Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>堆（heap）是一种满足特定条件的完全二叉树，分为大顶堆和小顶堆，通常用于实现优先队列，进行堆排序。本文主要介绍推数据结构以及其 Go 实现。</p><a id="more"></a><h1 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h1><p>堆是一种完全二叉树，与优先队列等价，分为两种类型：</p><ul><li>小顶堆（min heap）：任意节点的值 &lt;= 其子节点的值</li><li>大顶堆（max heap）：任意节点的值 &gt;= 其子节点的值</li></ul><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/heap.png" alt="heap" style="zoom: 50%;" /></p><p>从存储结构来看，实际就是树层次遍历所得的队列。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20250117014014174.png" alt="image-20250117014014174" style="zoom:50%;" /></p><h1 id="container-heap"><a href="#container-heap" class="headerlink" title="container/heap"></a><code>container/heap</code></h1><p>Golang 标准库 <code>container/heap</code> 提供了堆的快速实现。</p><h2 id="接口定义源码"><a href="#接口定义源码" class="headerlink" title="接口定义源码"></a>接口定义源码</h2><p><code>heap.Interface</code> 接口定义源码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">sort.Interface</span><br><span class="line">Push(x any) <span class="comment">// add x as element Len()</span></span><br><span class="line">Pop() any   <span class="comment">// remove and return element Len() - 1.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sort.Interface</code> 接口定义源码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Len is the number of elements in the collection.</span></span><br><span class="line">Len() <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Less reports whether the element with index i</span></span><br><span class="line"><span class="comment">// must sort before the element with index j.</span></span><br><span class="line">Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Swap swaps the elements with indexes i and j.</span></span><br><span class="line">Swap(i, j <span class="keyword">int</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h2><p>通过实现 <code>heap.Interface</code> 接口，从而实现一个堆。</p><h3 id="堆的结构体"><a href="#堆的结构体" class="headerlink" title="堆的结构体"></a>堆的结构体</h3><p>首先定义堆的结构体，堆的数据类型需要是一个切片（实际以切片形式存储），切片的 type 即为堆的每个元素的数据类型。</p><ul><li><p>最常用的整数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> IntHeap []<span class="keyword">int</span></span><br></pre></td></tr></table></figure></li><li><p>也可使用结构体的切片，比如想要实现一个每个元素都是一个长方体的优先队列</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Rectangle <span class="keyword">struct</span> &#123;</span><br><span class="line">width  <span class="keyword">int</span></span><br><span class="line">height <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RectangleHeap []Rectangle</span><br></pre></td></tr></table></figure></li></ul><h3 id="Len-int"><a href="#Len-int" class="headerlink" title="Len() int"></a><code>Len() int</code></h3><p>用于返回堆中元素的数量。</p><p>实现方式相对固定，返回切片长度即可。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h IntHeap)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(h)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Less-i-j-int-bool"><a href="#Less-i-j-int-bool" class="headerlink" title="Less(i, j int) bool"></a><code>Less(i, j int) bool</code></h3><p>用于设置堆的元素的大小比较方法。</p><p>比较索引为 <code>i</code> 和 <code>j</code> 上的两个元素，如果 <code>i</code> 索引元素应该排在 <code>j</code> 的前面，即返回 true。</p><ul><li>小顶堆：$h[i] &lt; h[j]$，则返回 true</li><li>大顶堆：$h[i] &gt; h[j]$，则返回 true</li></ul><p>示例：</p><ul><li><p>整数小顶堆</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h IntHeap)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> h[i] &lt; h[j]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>整数大顶堆</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h IntHeap)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> h[i] &gt; h[j]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>长方体大顶堆，面积比大小</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span> <span class="title">area</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.width * r.height</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h RectangleHeap)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> h[i].area() &gt; h[j].area()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Swap-i-j-int"><a href="#Swap-i-j-int" class="headerlink" title="Swap(i, j int)"></a><code>Swap(i, j int)</code></h3><p>用于交换堆中索引 <code>i</code> 和 <code>j</code> 位置的元素。</p><p>实现方式相对固定，直接交换二者存储位置。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h IntHeap)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">h[i], h[j] = h[j], h[i]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Push-x-any"><a href="#Push-x-any" class="headerlink" title="Push(x any)"></a><code>Push(x any)</code></h3><p>将新的元素 x 加入堆切片，即 append 到最后。</p><p>注：接口的 <code>Push(x any)</code> 只需要将新元素加到堆尾即可，使用 <code>heap.Push()</code> 时，将会调用用户实现的  <code>Push(x any)</code> ，将元素加到队尾，然后自动实现上浮排序。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *IntHeap)</span> <span class="title">Push</span><span class="params">(x any)</span></span> &#123;</span><br><span class="line">*h = <span class="built_in">append</span>(*h, x.(<span class="keyword">int</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Pop-any"><a href="#Pop-any" class="headerlink" title="Pop() any"></a><code>Pop() any</code></h3><p>从堆切片中移除最后一个元素，并返回。</p><p>注：使用 <code>heap.Pop()</code> 时，将先将堆顶的元素下沉到队尾，然后调用用户实现的  <code>Pop() any</code>  删除并返回。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *IntHeap)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">any</span></span> &#123;</span><br><span class="line">n := <span class="built_in">len</span>(*h)</span><br><span class="line">x := (*h)[n<span class="number">-1</span>]</span><br><span class="line">*h = (*h)[:n<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>实现 <code>Push()</code> 和 <code>Pop()</code> 时，都需使用指针接收。切片是引用类型，但在方法中增加/删除元素，可能会修改切片本身，所以需使用指针接收。</p></blockquote><h2 id="堆的使用"><a href="#堆的使用" class="headerlink" title="堆的使用"></a>堆的使用</h2><h3 id="heap-Init"><a href="#heap-Init" class="headerlink" title="heap.Init()"></a><code>heap.Init()</code></h3><p>作用：完成堆的初始化。调用结束后，堆的切片即完成排序。</p><p>实现方式：将堆的非叶子节点一一下沉。（由底向上，从第一个非叶子节点开始下沉，直到堆顶，叶子节点没有下沉的必要）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">(h Interface)</span></span> &#123;</span><br><span class="line"><span class="comment">// heapify</span></span><br><span class="line">n := h.Len()</span><br><span class="line"><span class="keyword">for</span> i := n/<span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">down(h, i, n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="heap-Push"><a href="#heap-Push" class="headerlink" title="heap.Push()"></a><code>heap.Push()</code></h3><p>作用：将新元素推入堆中，并完成排序。</p><p>实现方式：先调用用户实现的 <code>Push()</code> 接口，将新元素加入切片的最尾部，再将尾部上浮。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Push</span><span class="params">(h Interface, x any)</span></span> &#123;</span><br><span class="line">h.Push(x)</span><br><span class="line">up(h, h.Len()<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="heap-Pop"><a href="#heap-Pop" class="headerlink" title="heap.Pop()"></a><code>heap.Pop()</code></h3><p>作用：将堆顶推出并返回。</p><p>实现方式：先将堆顶和堆尾交换，再将新换上的堆顶下沉，最后调用用户实现的 <code>Pop()</code> 接口，将堆尾推出并返回。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pop</span><span class="params">(h Interface)</span> <span class="title">any</span></span> &#123;</span><br><span class="line">n := h.Len() - <span class="number">1</span></span><br><span class="line">h.Swap(<span class="number">0</span>, n)</span><br><span class="line">down(h, <span class="number">0</span>, n)</span><br><span class="line"><span class="keyword">return</span> h.Pop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="滑动窗口最大值"><a href="#滑动窗口最大值" class="headerlink" title="滑动窗口最大值"></a><a href="https://leetcode.cn/problems/sliding-window-maximum?envType=study-plan-v2&amp;envId=top-100-liked" target="_blank" rel="noopener">滑动窗口最大值</a></h2><p>给你一个整数数组 <code>nums</code>，有一个大小为 <code>k</code> 的滑动窗口从数组的最左侧移动到数组的最右侧。你只可以看到在滑动窗口内的 <code>k</code> 个数字。滑动窗口每次只向右移动一位。</p><p>返回 <em>滑动窗口中的最大值</em> 。</p><p><strong>示例 1：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">输入：nums &#x3D; [1,3,-1,-3,5,3,6,7], k &#x3D; 3</span><br><span class="line">输出：[3,3,5,5,6,7]</span><br><span class="line">解释：</span><br><span class="line">滑动窗口的位置                最大值</span><br><span class="line">---------------               -----</span><br><span class="line">[1  3  -1] -3  5  3  6  7       3</span><br><span class="line"> 1 [3  -1  -3] 5  3  6  7       3</span><br><span class="line"> 1  3 [-1  -3  5] 3  6  7       5</span><br><span class="line"> 1  3  -1 [-3  5  3] 6  7       5</span><br><span class="line"> 1  3  -1  -3 [5  3  6] 7       6</span><br><span class="line"> 1  3  -1  -3  5 [3  6  7]      7</span><br></pre></td></tr></table></figure><p>优先队列方法题解：</p><ol><li>将前 k-1 个数字初始化大顶堆</li><li>从第 k 个数字开始遍历<ol><li>将该数字 Push 入堆</li><li>查看堆顶元素<ul><li>如果已经不在滑动窗口里，则 Pop 出堆</li><li>否则，该堆顶即为现在滑动窗口里最大元素，加入结果</li></ul></li></ol></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> element <span class="keyword">struct</span> &#123;</span><br><span class="line">num   <span class="keyword">int</span></span><br><span class="line">index <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ElementHeap []element</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h ElementHeap)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(h)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h ElementHeap)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> h[i].num &gt; h[j].num</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h ElementHeap)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">h[i], h[j] = h[j], h[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *ElementHeap)</span> <span class="title">Push</span><span class="params">(x any)</span></span> &#123;</span><br><span class="line">*h = <span class="built_in">append</span>(*h, x.(element))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *ElementHeap)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">any</span></span> &#123;</span><br><span class="line">n := h.Len()</span><br><span class="line">x := (*h)[n<span class="number">-1</span>]</span><br><span class="line">*h = (*h)[:n<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">maxSlidingWindow</span><span class="params">(nums []<span class="keyword">int</span>, k <span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">h := &amp;ElementHeap&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; k<span class="number">-1</span>; i++ &#123;</span><br><span class="line">*h = <span class="built_in">append</span>(*h, element&#123;</span><br><span class="line">num:   nums[i],</span><br><span class="line">index: i,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">heap.Init(h)</span><br><span class="line">ans := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="built_in">len</span>(nums))</span><br><span class="line"><span class="keyword">for</span> i := k - <span class="number">1</span>; i &lt; <span class="built_in">len</span>(nums); i++ &#123;</span><br><span class="line">heap.Push(h, element&#123;</span><br><span class="line">num:   nums[i],</span><br><span class="line">index: i,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (*h)[<span class="number">0</span>].index &lt; i-k+<span class="number">1</span> &#123;</span><br><span class="line">heap.Pop(h)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ans = <span class="built_in">append</span>(ans, (*h)[<span class="number">0</span>].num)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ans</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;堆（heap）是一种满足特定条件的完全二叉树，分为大顶堆和小顶堆，通常用于实现优先队列，进行堆排序。本文主要介绍推数据结构以及其 Go 实现。&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://gy23333.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="算法" scheme="https://gy23333.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="堆" scheme="https://gy23333.github.io/tags/%E5%A0%86/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry分布式链路追踪</title>
    <link href="https://gy23333.github.io/2025/01/06/OpenTelemetry%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"/>
    <id>https://gy23333.github.io/2025/01/06/OpenTelemetry%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/</id>
    <published>2025-01-05T16:37:19.000Z</published>
    <updated>2025-01-06T17:48:25.073Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p><a href="https://jckling.github.io/2021/04/02/Jaeger/全链路追踪与%20Jaeger%20入门/index.html" target="_blank" rel="noopener">https://jckling.github.io/2021/04/02/Jaeger/全链路追踪与%20Jaeger%20入门/index.html</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name jaeger   -e COLLECTOR_ZIPKIN_HTTP_PORT&#x3D;9411   -p 5775:5775&#x2F;udp   -p 6831:6831&#x2F;udp   -p 6832:6832&#x2F;udp   -p 5778:5778   -p 16686:16686   -p 14268:14268   -p 14250:14250   -p 9411:9411   quay.io&#x2F;jaegertracing&#x2F;all-in-one:1.64.0</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>TLS 证书</title>
    <link href="https://gy23333.github.io/2024/12/24/TLS-%E8%AF%81%E4%B9%A6/"/>
    <id>https://gy23333.github.io/2024/12/24/TLS-%E8%AF%81%E4%B9%A6/</id>
    <published>2024-12-24T14:55:05.000Z</published>
    <updated>2024-12-24T14:55:05.810Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Go 依赖管理</title>
    <link href="https://gy23333.github.io/2024/12/24/Go-%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86/"/>
    <id>https://gy23333.github.io/2024/12/24/Go-%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86/</id>
    <published>2024-12-23T17:18:11.000Z</published>
    <updated>2024-12-23T17:28:37.726Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>Go 依赖管理</p><a id="more"></a><h1 id="初始化-Go-项目"><a href="#初始化-Go-项目" class="headerlink" title="初始化 Go 项目"></a>初始化 Go 项目</h1><ol><li><p>新建项目文件夹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir survey-test</span><br><span class="line">cd survey-test</span><br></pre></td></tr></table></figure></li><li><p>初始化 Go 模块</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go mod init github.com/GY23333/survey<span class="literal">-test</span></span><br><span class="line">go: creating new go.mod: module github.com/GY23333/survey<span class="literal">-test</span></span><br></pre></td></tr></table></figure><p>该步会自动生成 go.mod 文件</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module github.com/GY23333/survey-test</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="number">1.23</span><span class="number">.3</span></span><br></pre></td></tr></table></figure></li><li><p>如需获取依赖</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com&#x2F;gorilla&#x2F;mux</span><br></pre></td></tr></table></figure></li><li></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Go 依赖管理&lt;/p&gt;</summary>
    
    
    
    <category term="Golang" scheme="https://gy23333.github.io/categories/Golang/"/>
    
    
    <category term="Golang" scheme="https://gy23333.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Go Package: survey</title>
    <link href="https://gy23333.github.io/2024/12/24/Go-Package-survey/"/>
    <id>https://gy23333.github.io/2024/12/24/Go-Package-survey/</id>
    <published>2024-12-23T16:44:26.000Z</published>
    <updated>2024-12-25T18:09:26.971Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>Go 交互式命令行工具库，提供了包括文本输入、选择菜单、确认提示、多项选择等多种交互类型，帮助快速构建交互式命令行页面。</p><a id="more"></a><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com&#x2F;AlecAivazis&#x2F;survey&#x2F;v2</span><br></pre></td></tr></table></figure><h1 id="Prompt"><a href="#Prompt" class="headerlink" title="Prompt"></a>Prompt</h1><h2 id="Input-单行输入"><a href="#Input-单行输入" class="headerlink" title="Input 单行输入"></a>Input 单行输入</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> username <span class="keyword">string</span></span><br><span class="line">prompt := &amp;survey.Input&#123;</span><br><span class="line">  Message: <span class="string">"Input username:"</span>,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;username)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241225015619560.png" alt="image-20241225015619560" style="zoom:67%;" /></p><p>可以通过设置 <code>Suggest</code> 来给用户提供建议，帮助补全输入，<code>Suggest</code> 为由当前输入值返回建议值列表的方法。如下面补全文件路径示例。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path <span class="keyword">string</span></span><br><span class="line">prompt := &amp;survey.Input&#123;</span><br><span class="line">  Message: <span class="string">"Input file path:"</span>,</span><br><span class="line">  Suggest: <span class="function"><span class="keyword">func</span><span class="params">(toComplete <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    files, _ := filepath.Glob(toComplete + <span class="string">"*"</span>)</span><br><span class="line">    <span class="keyword">return</span> files</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;path)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241225020920573.png" alt=""></p><h2 id="Multiline-多行输入"><a href="#Multiline-多行输入" class="headerlink" title="Multiline 多行输入"></a>Multiline 多行输入</h2><h2 id="Select-单选"><a href="#Select-单选" class="headerlink" title="Select 单选"></a>Select 单选</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tool <span class="keyword">string</span></span><br><span class="line">prompt := &amp;survey.Select&#123;</span><br><span class="line">  Message: <span class="string">"Choose a tool:"</span>,</span><br><span class="line">  Options: []<span class="keyword">string</span>&#123;<span class="string">"toolA"</span>, <span class="string">"toolB"</span>, <span class="string">"toolC"</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;tool)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241225013809541.png" style="zoom: 67%;" /></p><p>可以通过设置 <code>Description</code> 给每个选项添加描述， <code>Description</code>  为由选项值/序号返回描述的方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tool <span class="keyword">string</span></span><br><span class="line">description := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">  <span class="string">"toolA"</span>: <span class="string">"Description for toolA"</span>,</span><br><span class="line">  <span class="string">"toolB"</span>: <span class="string">"Description for toolB"</span>,</span><br><span class="line">  <span class="string">"toolC"</span>: <span class="string">"Description for toolC"</span>,</span><br><span class="line">&#125;</span><br><span class="line">prompt := &amp;survey.Select&#123;</span><br><span class="line">  Message: <span class="string">"Choose a tool:"</span>,</span><br><span class="line">  Options: []<span class="keyword">string</span>&#123;<span class="string">"toolA"</span>, <span class="string">"toolB"</span>, <span class="string">"toolC"</span>&#125;,</span><br><span class="line">  Description: <span class="function"><span class="keyword">func</span><span class="params">(value <span class="keyword">string</span>, index <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> description[value]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;tool)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241225014328295.png" style="zoom:67%;" /></p><h2 id="MultiSelect-多选"><a href="#MultiSelect-多选" class="headerlink" title="MultiSelect 多选"></a>MultiSelect 多选</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">days := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">prompt := &amp;survey.MultiSelect&#123;</span><br><span class="line">    Message: <span class="string">"What days do you prefer:"</span>,</span><br><span class="line">    Options: []<span class="keyword">string</span>&#123;<span class="string">"Sunday"</span>, <span class="string">"Monday"</span>, <span class="string">"Tuesday"</span>, <span class="string">"Wednesday"</span>, <span class="string">"Thursday"</span>, <span class="string">"Friday"</span>, <span class="string">"Saturday"</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;days)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241226000302861.png" alt="image-20241226000302861"></p><h2 id="Confirm-确认"><a href="#Confirm-确认" class="headerlink" title="Confirm 确认"></a>Confirm 确认</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">answer := <span class="literal">false</span></span><br><span class="line">prompt := &amp;survey.Confirm&#123;</span><br><span class="line">  Message: <span class="string">"Are you sure to continue?"</span>,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;answer)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241226004601642.png" alt="image-20241226004601642" style="zoom:67%;" /></p><h2 id="Password-密码"><a href="#Password-密码" class="headerlink" title="Password 密码"></a>Password 密码</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">password := <span class="string">""</span></span><br><span class="line">prompt := &amp;survey.Password&#123;</span><br><span class="line">  Message: <span class="string">"Please type your password"</span>,</span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;password)</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241226004825233.png" alt="image-20241226004825233" style="zoom:67%;" /></p><h1 id="Option"><a href="#Option" class="headerlink" title="Option"></a>Option</h1><h2 id="Validator"><a href="#Validator" class="headerlink" title="Validator"></a>Validator</h2><p>设置输入验证，提供输入验证函数（输入：输入值，返回 error），如果用户输入验证不通过，则提示错误，并重新提问。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> input <span class="keyword">string</span></span><br><span class="line">prompt := &amp;survey.Input&#123;</span><br><span class="line">  Message: <span class="string">"Input number:"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 验证输入为数字，并在0到10范围内</span></span><br><span class="line">vaildInputNumber := <span class="function"><span class="keyword">func</span><span class="params">(val <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  num, err := strconv.Atoi(val.(<span class="keyword">string</span>))</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"not number"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> num &lt; <span class="number">0</span> || num &gt; <span class="number">10</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"not in 0~10"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">survey.AskOne(prompt, &amp;input, survey.WithValidator(vaildInputNumber))</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241226013939360.png" alt="image-20241226013939360" style="zoom:67%;" /></p><p>Survey 库也提供了一些可直接调用的验证函数</p><ul><li><code>Required</code>：要求非空</li><li><code>MinLength(n)</code>：最小长度</li><li><code>MaxLength(n)：最大长度</code></li></ul><h1 id="Ask"><a href="#Ask" class="headerlink" title="Ask"></a>Ask</h1><p><code>Ask</code>支持连续问多个问题，设置多个问题，每个问题可以包括四个部分：</p><ul><li><code>Name</code>：与回答结构体里的元素对应，用于指名结果解析到哪个元素</li><li><code>Prompt</code>：具体的问题</li><li><code>Vaildate</code>：回答的验证方法</li><li><code>Transform</code>：自动更改格式</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">qs := []*survey.Question&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    Name:      <span class="string">"name"</span>,</span><br><span class="line">    Prompt:    &amp;survey.Input&#123;Message: <span class="string">"What is your name?"</span>&#125;,</span><br><span class="line">    Validate:  survey.Required,</span><br><span class="line">    Transform: survey.Title,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    Name: <span class="string">"color"</span>,</span><br><span class="line">    Prompt: &amp;survey.Select&#123;</span><br><span class="line">      Message: <span class="string">"Choose a color:"</span>,</span><br><span class="line">      Options: []<span class="keyword">string</span>&#123;<span class="string">"red"</span>, <span class="string">"blue"</span>, <span class="string">"green"</span>&#125;,</span><br><span class="line">      Default: <span class="string">"red"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    Name:   <span class="string">"age"</span>,</span><br><span class="line">    Prompt: &amp;survey.Input&#123;Message: <span class="string">"How old are you?"</span>&#125;,</span><br><span class="line">    Validate: <span class="function"><span class="keyword">func</span><span class="params">(val <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">      _, err := strconv.Atoi(val.(<span class="keyword">string</span>))</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"not number"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">answers := <span class="keyword">struct</span> &#123;</span><br><span class="line">  Name          <span class="keyword">string</span> <span class="comment">// survey will match the question and field names</span></span><br><span class="line">  FavoriteColor <span class="keyword">string</span> <span class="string">`survey:"color"`</span> <span class="comment">// or you can tag fields to match a specific name</span></span><br><span class="line">  Age           <span class="keyword">int</span>    <span class="comment">// if the types don't match, survey will convert it</span></span><br><span class="line">&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// perform the questions</span></span><br><span class="line">err := survey.Ask(qs, &amp;answers)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  fmt.Println(err.Error())</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241226020405076.png" alt="image-20241226020405076" style="zoom:67%;" /></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://github.com/AlecAivazis/survey" target="_blank" rel="noopener">https://github.com/AlecAivazis/survey</a></li><li><a href="https://pkg.go.dev/github.com/AlecAivazis/survey/v2#section-readme" target="_blank" rel="noopener">https://pkg.go.dev/github.com/AlecAivazis/survey/v2#section-readme</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Go 交互式命令行工具库，提供了包括文本输入、选择菜单、确认提示、多项选择等多种交互类型，帮助快速构建交互式命令行页面。&lt;/p&gt;</summary>
    
    
    
    <category term="Golang" scheme="https://gy23333.github.io/categories/Golang/"/>
    
    
    <category term="Golang" scheme="https://gy23333.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>IPIP隧道</title>
    <link href="https://gy23333.github.io/2024/12/07/IPIP%E9%9A%A7%E9%81%93/"/>
    <id>https://gy23333.github.io/2024/12/07/IPIP%E9%9A%A7%E9%81%93/</id>
    <published>2024-12-06T16:47:53.000Z</published>
    <updated>2024-12-06T16:47:53.899Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>IPv6</title>
    <link href="https://gy23333.github.io/2024/12/07/IPv6/"/>
    <id>https://gy23333.github.io/2024/12/07/IPv6/</id>
    <published>2024-12-06T16:47:16.000Z</published>
    <updated>2025-02-18T17:24:18.406Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>IPv6 是网络层协议的第二代标准协议，将 IP 地址长度从原来的 32 位升级为 128 位，从根本上解决了 IP 地址耗尽的问题。</p><a id="more"></a><h1 id="IPv6-地址"><a href="#IPv6-地址" class="headerlink" title="IPv6 地址"></a>IPv6 地址</h1><p>IPv6 地址由 128 位二进制数组成，书写时采用十六进制，分为 8 组，组之间用 <code>:</code> 分开，每组 16 位，用 4 个十六进制表示。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX</span><br></pre></td></tr></table></figure><p>比如 <code>2001:00b8:130F:0000:0000:09C0:0000:0000</code></p><h1 id="简写"><a href="#简写" class="headerlink" title="简写"></a>简写</h1><p>如 IPv6 地址 <code>2001:00b8:130F:0000:0000:09C0:0000:0000</code></p><ol><li><p>每组前半部分的 <code>0</code> 可省去，<code>0000</code> 可简写为 <code>0</code></p><p><code>2001:b8:130F:0:0:9C0:0:0</code></p></li><li><p>连续的 <code>0</code> 可以用 <code>::</code> 缩写（只能用一个 <code>::</code>，且缩最前面那个连续 <code>0</code>）</p><p><code>2001:b8:130F::9C0:0:0</code></p></li></ol><h1 id="IPv4-转-IPv6"><a href="#IPv4-转-IPv6" class="headerlink" title="IPv4 转 IPv6"></a>IPv4 转 IPv6</h1><p>原 IPv4 地址转 IPv6 采用 <code>0:0:0:0:0:FFFF:IPv4-address</code> 格式。</p><p>如 <code>172.17.0.3</code> 变成 <code>0:0:0:0:0:FFFF:172.17.0.3</code></p><h1 id="地址结构"><a href="#地址结构" class="headerlink" title="地址结构"></a>地址结构</h1><p>IPv6 地址可以划分为两个部分：网络前缀、接口标识</p><ul><li>网络前缀：前 n 位划分为网络前缀，类似于 IPv4 中的网络号，一般推荐使用 64 位</li><li>接口标识：后 128-n 位划分为网络前缀，类似于 IPv4 中的主机号</li></ul><p>如 <code>2001:db8:130F:0000:0000:09C0:876A:130B/64</code>，<code>/</code> 后数字表示网络前缀的长度</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20250219010228278.png" alt="image-20250219010228278" style="zoom:67%;" /></p><h1 id="地址划分"><a href="#地址划分" class="headerlink" title="地址划分"></a>地址划分</h1><p>按照目的地址，可以将 IPv6 地址划分成下面三种类型：</p><ul><li>单播地址：唯一标识一个接口，和 IPv4 单播一样，点对点的通信。</li><li>组播地址：一点对多点的通信，和 IPv4 组播一样，发送到组播地址的数据包被传输给此地址所标识的所有接口。</li><li>任播地址：IPv6 相比 IPv4 新增地址类型，发送到任播地址的数据包被传输给此地址所标识的一组接口中距离源节点最近的一个接口。</li><li>IPv6 不支持广播，广播地址的功能均由组播地址来提供。IPv4 依赖 BGP 来实现任播。</li></ul><p>IPv6 单播地址又可分为</p><div class="table-container"><table><thead><tr><th>地址类型</th><th>二进制前缀</th><th>IPv6前缀标识</th></tr></thead><tbody><tr><td>链路本地单播地址</td><td>1111111010</td><td>FE80::/10</td></tr><tr><td>唯一本地地址</td><td>1111110</td><td>FC00::/7</td></tr><tr><td>环回地址</td><td>00…1 (128 bits)</td><td>::1/128</td></tr><tr><td>未指定地址</td><td>00…0 (128 bits)</td><td>::/128</td></tr><tr><td>全球单播地址</td><td>其他</td><td>-</td></tr></tbody></table></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;IPv6 是网络层协议的第二代标准协议，将 IP 地址长度从原来的 32 位升级为 128 位，从根本上解决了 IP 地址耗尽的问题。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux日志管理工具--logrotate</title>
    <link href="https://gy23333.github.io/2024/12/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7-logrotate/"/>
    <id>https://gy23333.github.io/2024/12/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7-logrotate/</id>
    <published>2024-12-06T16:45:51.000Z</published>
    <updated>2024-12-16T05:23:49.137Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>logrotate 是 Linux 系统中用来管理日志的工具，通过配置可以实现日志的自动轮转、压缩、删除、邮件发送功能。</p><a id="more"></a><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>logrotate 提供了日志的自动轮转、压缩、删除、邮件发送能力，可以设置定期或者限制文件大小来触发。</p><p>一般来说，logrotate 都是作为每日的定时任务运行，一般不会一天内处理多次，除非触发条件是基于文件的大小并且设置 logrotate 一天执行多次，或者在执行时使用强制选项 <code>-f</code></p><h1 id="logrotate-命令"><a href="#logrotate-命令" class="headerlink" title="logrotate 命令"></a>logrotate 命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate [OPTION...] &lt;configfile&gt;</span><br></pre></td></tr></table></figure><ul><li><p><code>-d</code>, <code>--debug</code>：以调试模式运行，打印出详细的调试信息，但不执行任何轮转操作</p></li><li><p><code>-f</code>, <code>--force</code>：强制执行日志轮转，即使不符合轮转条件</p></li><li><p><code>-v</code>, <code>--verbose</code>：在轮转时显示更多信息</p></li><li><p><code>-s</code>, <code>--state=statefile</code>：指定一个状态文件来记录日志轮转的历史状态，默认状态文件是 /var/lib/logrotate/status</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -s &#x2F;var&#x2F;log&#x2F;logrotate.status &#x2F;etc&#x2F;logrotate.conf</span><br></pre></td></tr></table></figure></li><li><p><code>-l</code>, <code>--log=logfile</code>：指定 logrotate 日志记入的日志文件</p></li><li><p><code>-m</code>, <code>--mail=command</code>：指定发送邮件的命令</p></li></ul><h1 id="logrotate-定时任务"><a href="#logrotate-定时任务" class="headerlink" title="logrotate 定时任务"></a>logrotate 定时任务</h1><h2 id="logrotate-配置文件"><a href="#logrotate-配置文件" class="headerlink" title="logrotate 配置文件"></a>logrotate 配置文件</h2><p>将 logrotate 配置文件按路径不同分为下面三种：</p><ul><li><code>/etc/logrotate.conf</code></li><li><code>/etc/logrotate.d/</code></li><li>其他路径</li></ul><h1 id="logrotate-配置"><a href="#logrotate-配置" class="headerlink" title="logrotate 配置"></a>logrotate 配置</h1><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://linux.die.net/man/8/logrotate" target="_blank" rel="noopener">logrotate 官方文档</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;logrotate 是 Linux 系统中用来管理日志的工具，通过配置可以实现日志的自动轮转、压缩、删除、邮件发送功能。&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://gy23333.github.io/categories/Linux/"/>
    
    
    <category term="logrotate" scheme="https://gy23333.github.io/tags/logrotate/"/>
    
  </entry>
  
  <entry>
    <title>基于FRRouting/Bird的OSPF组网及负载均衡实现</title>
    <link href="https://gy23333.github.io/2024/12/07/%E5%9F%BA%E4%BA%8EFRRouting-Bird%E7%9A%84OSPF%E7%BB%84%E7%BD%91%E5%8F%8A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E7%8E%B0/"/>
    <id>https://gy23333.github.io/2024/12/07/%E5%9F%BA%E4%BA%8EFRRouting-Bird%E7%9A%84OSPF%E7%BB%84%E7%BD%91%E5%8F%8A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E7%8E%B0/</id>
    <published>2024-12-06T16:36:31.000Z</published>
    <updated>2024-12-09T13:33:38.863Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>基于 FRRouting/Bird 配置多虚拟机之间的 OSPF 组网（建邻、路由交换），并实现多路径负载均衡。</p><a id="more"></a><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>FRRouting、Bird 都是常用的开源路由软件，支持 OSPF 协议。本文采用 FRRouting 作为两台 DNS Server 的路由发布器，Bird 作为 DR 兼 Client 的路由软件（在实际测试环境中，可以使用其中任一款软件来实现 OSPF 的组网），通过 FRRouting 发布 VIP，实现 OSPF 场景下的多路径负载均衡。</p><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="1、创建三台虚拟机，每台虚拟机至少有一张可用的网卡"><a href="#1、创建三台虚拟机，每台虚拟机至少有一张可用的网卡" class="headerlink" title="1、创建三台虚拟机，每台虚拟机至少有一张可用的网卡"></a>1、创建三台虚拟机，每台虚拟机至少有一张可用的网卡</h2><p>安装 Linux 虚拟机，本文安装了三台 Ubuntu 24.04.1，安装过程参考 <a href="https://gy23333.github.io/2023/03/19/Linux学习/#Linux虚拟机的安装">Mac安装虚拟机</a></p><h2 id="2、在其中一台虚拟机上安装-bird"><a href="#2、在其中一台虚拟机上安装-bird" class="headerlink" title="2、在其中一台虚拟机上安装 bird"></a>2、在其中一台虚拟机上安装 bird</h2><p><a href="https://gy23333.github.io/2024/12/03/bird/#安装-bird">bird安装方法</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bird2</span><br></pre></td></tr></table></figure><h2 id="3、在另外两台虚拟机上安装-FRRouting-以及-Coredns"><a href="#3、在另外两台虚拟机上安装-FRRouting-以及-Coredns" class="headerlink" title="3、在另外两台虚拟机上安装 FRRouting 以及 Coredns"></a>3、在另外两台虚拟机上安装 FRRouting 以及 Coredns</h2><p><a href="https://gy23333.github.io/2024/09/19/FRRouting/">FRRouting安装方法</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install frr</span><br></pre></td></tr></table></figure><p>Coredns 下载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;coredns&#x2F;coredns&#x2F;releases&#x2F;download&#x2F;v1.12.0&#x2F;coredns_1.12.0_linux_arm64.tgz</span><br><span class="line">tar -zxvf coredns_1.12.0_linux_arm64.tgz</span><br><span class="line">sudo mv coredns &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coredns --version</span><br></pre></td></tr></table></figure><h1 id="OSPF-建邻"><a href="#OSPF-建邻" class="headerlink" title="OSPF 建邻"></a>OSPF 建邻</h1><p>目标：以 Bird 节点作为 DR，实现 3 台虚拟机的建邻组网。</p><h2 id="FRRouting-配置-OSPF"><a href="#FRRouting-配置-OSPF" class="headerlink" title="FRRouting 配置 OSPF"></a>FRRouting 配置 OSPF</h2><h3 id="开启-ospfd-进程"><a href="#开启-ospfd-进程" class="headerlink" title="开启 ospfd 进程"></a>开启 ospfd 进程</h3><ol><li><p>修改 daemons 文件，默认位置在 <code>/etc/frr/daemons</code>，将 ospfd 开关打开</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ospfd&#x3D;yes</span><br></pre></td></tr></table></figure></li><li><p>重启 FRR，查看 ospfd 进程是否正常启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart frr</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2:~<span class="variable">$</span> systemctl status frr</span><br><span class="line">● frr.service - FRRouting</span><br><span class="line">     Loaded: loaded (/etc/systemd/system/frr.service; enabled; preset: enabled)</span><br><span class="line">     Active: active (running) since Sun <span class="number">2024</span><span class="literal">-12</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> UTC; <span class="number">5</span>s ago</span><br><span class="line">       Docs: https://frrouting.readthedocs.io/en/latest/setup.html</span><br><span class="line">    <span class="keyword">Process</span>: <span class="number">39653</span> ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=<span class="number">0</span>/SUCCESS)</span><br><span class="line">   Main PID: <span class="number">39664</span> (watchfrr)</span><br><span class="line">     Status: <span class="string">"FRR Operational"</span></span><br><span class="line">      Tasks: <span class="number">10</span> (limit: <span class="number">4550</span>)</span><br><span class="line">     Memory: <span class="number">18.6</span>M (peak: <span class="number">32.1</span>M)</span><br><span class="line">        CPU: <span class="number">117</span>ms</span><br><span class="line">     CGroup: /system.slice/frr.service</span><br><span class="line">             ├─<span class="number">39664</span> /usr/lib/frr/watchfrr <span class="literal">-d</span> <span class="operator">-F</span> traditional zebra mgmtd ospfd staticd</span><br><span class="line">             ├─<span class="number">39676</span> /usr/lib/frr/zebra <span class="literal">-d</span> <span class="operator">-F</span> traditional <span class="literal">-A</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="literal">-s</span> <span class="number">90000000</span></span><br><span class="line">             ├─<span class="number">39681</span> /usr/lib/frr/mgmtd <span class="literal">-d</span> <span class="operator">-F</span> traditional <span class="literal">-A</span> <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">             ├─<span class="number">39683</span> /usr/lib/frr/ospfd <span class="literal">-d</span> <span class="operator">-F</span> traditional <span class="literal">-A</span> <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">             └─<span class="number">39686</span> /usr/lib/frr/staticd <span class="literal">-d</span> <span class="operator">-F</span> traditional <span class="literal">-A</span> <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 frrinit.sh[<span class="number">39693</span>]: [<span class="number">39693</span>|<span class="type">ospfd</span>] done</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 staticd[<span class="number">39686</span>]: [<span class="type">VTVCM</span>-<span class="type">Y2NW3</span>] Configuration Read <span class="keyword">in</span> Took: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 frrinit.sh[<span class="number">39706</span>]: [<span class="number">39706</span>|<span class="type">staticd</span>] done</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 watchfrr[<span class="number">39664</span>]: [<span class="type">QDG3Y</span>-<span class="type">BY5TN</span>] zebra state -&gt; up : connect succeeded</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 frrinit.sh[<span class="number">39653</span>]:  * Started watchfrr</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 watchfrr[<span class="number">39664</span>]: [<span class="type">QDG3Y</span>-<span class="type">BY5TN</span>] mgmtd state -&gt; up : connect succeeded</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 watchfrr[<span class="number">39664</span>]: [<span class="type">QDG3Y</span>-<span class="type">BY5TN</span>] ospfd state -&gt; up : connect succeeded</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 watchfrr[<span class="number">39664</span>]: [<span class="type">QDG3Y</span>-<span class="type">BY5TN</span>] staticd state -&gt; up : connect succeeded</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 watchfrr[<span class="number">39664</span>]: [<span class="type">KWE5Q</span>-<span class="type">QNGFC</span>] all daemons up, doing startup<span class="literal">-complete</span> notify</span><br><span class="line">Dec <span class="number">08</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">09</span> ubuntu2 systemd[<span class="number">1</span>]: Started frr.service - FRRouting.</span><br></pre></td></tr></table></figure></li></ol><h3 id="FRR-配置"><a href="#FRR-配置" class="headerlink" title="FRR 配置"></a>FRR 配置</h3><p>该 FRR 节点网卡信息</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">guoyi@ubuntu2:~<span class="variable">$</span> ip a</span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">62</span>:<span class="number">77</span>:<span class="number">76</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp2s0</span><br><span class="line">    inet <span class="number">172.16</span>.<span class="number">19.131</span>/<span class="number">24</span> metric <span class="number">100</span> brd <span class="number">172.16</span>.<span class="number">19.255</span> scope global dynamic ens160</span><br><span class="line">       valid_lft <span class="number">1194</span>sec preferred_lft <span class="number">1194</span>sec</span><br><span class="line">    inet6 fe80::<span class="number">20</span>c:<span class="number">29</span>ff:fe62:<span class="number">7776</span>/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>使用 ens160 网卡作为 OSPF 网卡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">!</span><br><span class="line">interface ens160</span><br><span class="line"> ip ospf area 0.0.0.0</span><br><span class="line"> ip ospf dead-interval 20</span><br><span class="line"> ip ospf hello-interval 5</span><br><span class="line"> ip ospf priority 0</span><br><span class="line">exit</span><br><span class="line">!</span><br><span class="line">router ospf</span><br><span class="line"> ospf router-id 172.16.19.131</span><br><span class="line">exit</span><br><span class="line">!</span><br></pre></td></tr></table></figure><ul><li><code>ip ospf area 0.0.0.0</code> <ul><li>将该网卡配置为 OSPF 网卡，并设置 area 为 <code>0.0.0.0</code> </li><li>也可在 <code>router ospf</code> 下配置 <code>network 172.16.19.0/24 area 0.0.0.0</code>，但此配置会将所有该网段的网卡设置为 OSPF 网卡</li></ul></li><li><code>ip ospf dead-interval 20</code>、<code>ip ospf hello-interval 5</code><ul><li>设置 hello 和 dead 的时间间隔</li><li>需建邻的所有节点这两个配置需相同</li></ul></li><li><code>ip ospf priority 0</code><ul><li>此节点不竞选 DR/BDR</li></ul></li><li><code>ospf router-id 172.16.19.131</code><ul><li>area 内该 OSPF 节点的唯一标识，一般用网卡 IP 来表示</li></ul></li></ul><h2 id="Bird-配置-OSPF"><a href="#Bird-配置-OSPF" class="headerlink" title="Bird 配置 OSPF"></a>Bird 配置 OSPF</h2><p>使用 ens256 网卡作为 OSPF 网卡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protocol ospf v2 &#123;</span><br><span class="line">        area 0 &#123;</span><br><span class="line">                interface &quot;ens256&quot; &#123;</span><br><span class="line">                        priority 1;</span><br><span class="line">                        hello 10;</span><br><span class="line">                        dead 40;</span><br><span class="line">                &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>priority 1</code><ul><li>参与竞选，且优先级最高</li></ul></li></ul><h2 id="查看建邻"><a href="#查看建邻" class="headerlink" title="查看建邻"></a>查看建邻</h2><p>BIRD 节点作为 DR，查看其他的节点状态，均建邻成功（Full）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bird&gt; show ospf neighbors</span><br><span class="line">ospf1:</span><br><span class="line">Router ID       Pri          State      DTime   Interface  Router IP</span><br><span class="line">172.16.19.131     0     Full&#x2F;Other      17.621  ens256     172.16.19.131</span><br><span class="line">172.16.19.132     0     Full&#x2F;Other      19.486  ens256     172.16.19.132</span><br></pre></td></tr></table></figure><p>FRRouting 节点作为 Other，只需与 DR 节点建邻成功，Other 节点之间处于 2-Way 状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu2# show ip ospf neighbor</span><br><span class="line"></span><br><span class="line">Neighbor ID     Pri State           Up Time         Dead Time Address         Interface                        RXmtL RqstL DBsmL</span><br><span class="line">172.16.19.129     1 Full&#x2F;DR         3m18s             16.350s 172.16.19.130   ens160:172.16.19.131                 0     0     0</span><br><span class="line">172.16.19.132     0 2-Way&#x2F;DROther   3m49s             15.307s 172.16.19.132   ens160:172.16.19.131                 0     0     0</span><br></pre></td></tr></table></figure><h2 id="非默认路由网卡建邻问题"><a href="#非默认路由网卡建邻问题" class="headerlink" title="非默认路由网卡建邻问题"></a>非默认路由网卡建邻问题</h2><p>使用非默认路由网卡作为 OSPF 网卡时，如开启严格的反向路由检查，收到的组播 224.0.0.5 的 hello 包会被 rp_filter 过滤掉，导致 ospfd 进程无法收到 hello 包，也就无法建邻。</p><p>解决方法：关闭或使用 loose 的反向路由检查。详细参考：<a href="https://gy23333.github.io/2024/11/22/rp-filter反向路由过滤/">rp_filter反向路由过滤</a></p><h1 id="OSPF-多路径负载均衡"><a href="#OSPF-多路径负载均衡" class="headerlink" title="OSPF 多路径负载均衡"></a>OSPF 多路径负载均衡</h1><p>OSPF 支持多路径的负载均衡，如两台 DNS Server，使用同样的 VIP，通过 OSPF 路由可以实现流量的负载均衡。</p><h2 id="FRRouting-发布-VIP"><a href="#FRRouting-发布-VIP" class="headerlink" title="FRRouting 发布 VIP"></a>FRRouting 发布 VIP</h2><p>添加并开启虚拟网卡 vip_if0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link add vip_if0 type dummy</span><br><span class="line">sudo ip link set vip_if0 up</span><br></pre></td></tr></table></figure><p>FRR 配置 vip_if0 网卡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">!</span><br><span class="line">interface vip_if0</span><br><span class="line"> ip address 10.0.0.10&#x2F;32</span><br><span class="line"> ip ospf area 0.0.0.0</span><br><span class="line">exit</span><br><span class="line">!</span><br></pre></td></tr></table></figure><ul><li><code>ip address 10.0.0.10/32</code><ul><li>添加 <code>10.0.0.10/32</code> 作为 VIP</li></ul></li><li><code>ip ospf area 0.0.0.0</code><ul><li>设置 vip_if0 为 OSPF 网卡，但此虚拟网卡实际无法建邻</li></ul></li></ul><h2 id="BIRD-添加路由"><a href="#BIRD-添加路由" class="headerlink" title="BIRD 添加路由"></a>BIRD 添加路由</h2><p>检查 BIRD 配置是否支持路由导出以及多路径路由</p><ol><li><p>确认 BIRD 开启将学到的路由导出到内核路由表，确认 <code>export all;</code> 开启</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protocol kernel &#123;</span><br><span class="line">        ipv4 &#123;                  # Connect protocol to IPv4 table by channel</span><br><span class="line">#             table master4;    # Default IPv4 table is master4</span><br><span class="line">#             import all;       # Import to table, default is import all</span><br><span class="line">              export all;       # Export to protocol. default is export none</span><br><span class="line">        &#125;;</span><br><span class="line">#       learn;                  # Learn alien routes from the kernel</span><br><span class="line">#       kernel table 10;        # Kernel table to synchronize with (default: main)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>确认 OSPF 开启 ecmp，以支持 OSPF 多路径。ecmp 默认（不填写）为开启状态，limit 默认 16</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protocol ospf v2 &#123;</span><br><span class="line">        ecmp &lt;switch&gt; [limit &lt;num&gt;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>查看 BIRD 是否学习到 VIP 路由，可以看到已经学习到了该 VIP 的两条路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bird&gt; show route</span><br><span class="line">Table master4:</span><br><span class="line">10.0.0.10&#x2F;32         unicast [ospf1 05:38:47.681] * I (150&#x2F;20) [172.16.19.132]</span><br><span class="line">        via 172.16.19.131 on ens256 weight 1</span><br><span class="line">        via 172.16.19.132 on ens256 weight 1</span><br><span class="line">172.16.19.0&#x2F;24       unicast [ospf1 04:35:44.681] * I (150&#x2F;10) [172.16.19.129]</span><br><span class="line">        dev ens256</span><br></pre></td></tr></table></figure><p>查看是否导入到了 Linux 路由表</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:/home/guoyi/workplace<span class="comment"># ip route show</span></span><br><span class="line">...</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.10</span> proto bird metric <span class="number">32</span></span><br><span class="line">        nexthop via <span class="number">172.16</span>.<span class="number">19.131</span> dev ens256 weight <span class="number">1</span></span><br><span class="line">        nexthop via <span class="number">172.16</span>.<span class="number">19.132</span> dev ens256 weight <span class="number">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="配置并运行-Coredns"><a href="#配置并运行-Coredns" class="headerlink" title="配置并运行 Coredns"></a>配置并运行 Coredns</h2><ol><li><p>添加 Coredns 配置及域名解析</p><p>/etc/coredns/Corefile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">example.com &#123;</span><br><span class="line">    log</span><br><span class="line">    file &#x2F;etc&#x2F;coredns&#x2F;db.example.com</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>/etc/coredns/db.example.com</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3600</span><br><span class="line">@   IN  SOA ns.example.com. admin.example.com. (</span><br><span class="line">        1   ; Serial</span><br><span class="line">        3600    ; Refresh</span><br><span class="line">        1800    ; Retry</span><br><span class="line">        604800  ; Expire</span><br><span class="line">        86400 ) ; Minimum TTL</span><br><span class="line"></span><br><span class="line">@   IN  NS  ns.example.com.</span><br><span class="line">@   IN  A   192.168.1.10</span><br><span class="line">ns  IN  A   192.168.1.10</span><br></pre></td></tr></table></figure></li><li><p>停止 systemd-resolve</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop systemd-resolved</span><br></pre></td></tr></table></figure></li><li><p>运行 Coredns</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coredns -conf &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br></pre></td></tr></table></figure></li><li><p>检查 Coredns 是否正常</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">guoyi@ubuntu2:~<span class="variable">$</span> dig @<span class="number">127.0</span>.<span class="number">0.1</span> example.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG <span class="number">9.18</span>.<span class="number">28</span><span class="literal">-0ubuntu0</span>.<span class="number">24.04</span>.<span class="number">1</span><span class="literal">-Ubuntu</span> &lt;&lt;&gt;&gt; @<span class="number">127.0</span>.<span class="number">0.1</span> example.com</span><br><span class="line">; (<span class="number">1</span> server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: <span class="number">45115</span></span><br><span class="line">;; flags: qr aa rd; QUERY: <span class="number">1</span>, ANSWER: <span class="number">1</span>, AUTHORITY: <span class="number">1</span>, ADDITIONAL: <span class="number">1</span></span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: <span class="number">0</span>, flags:; udp: <span class="number">1232</span></span><br><span class="line">; COOKIE: a29f8e8fa133c213 (echoed)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;example.com.                   <span class="keyword">IN</span>      A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">example.com.            <span class="number">3600</span>    <span class="keyword">IN</span>      A       <span class="number">192.168</span>.<span class="number">1.10</span></span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">example.com.            <span class="number">3600</span>    <span class="keyword">IN</span>      NS      ns.example.com.</span><br><span class="line"></span><br><span class="line">;; Query time: <span class="number">0</span> msec</span><br><span class="line">;; SERVER: <span class="number">127.0</span>.<span class="number">0.1</span><span class="comment">#53(127.0.0.1) (UDP)</span></span><br><span class="line">;; WHEN: Mon Dec <span class="number">09</span> <span class="number">12</span>:<span class="number">50</span>:<span class="number">07</span> UTC <span class="number">2024</span></span><br><span class="line">;; MSG SIZE  rcvd: <span class="number">118</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="打流"><a href="#打流" class="headerlink" title="打流"></a>打流</h2><p>在 BIRD 节点通过 dig VIP 打流，查看两个 Coredns 服务器日志是否负载均衡承接流量。</p><ol><li><p>打流前先确认 BIRD 节点内核配置 <code>net.ipv4.fib_multipath_hash_policy</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl <span class="literal">-a</span> | grep net.ipv4.fib_multipath_hash_policy</span><br></pre></td></tr></table></figure><p>该配置设置了多路径路由哈希策略，相同元组的包在多路径下会选择同一路径</p><ul><li><code>net.ipv4.fib_multipath_hash_policy=0</code>：{src_ip,  dst_ip}</li><li><code>net.ipv4.fib_multipath_hash_policy=1</code>：{src_ip,  src_port , dst_ip, dst_port, proto}</li></ul><p>需将 <code>net.ipv4.fib_multipath_hash_policy</code> 设置为 1</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl <span class="literal">-w</span> net.ipv4.fib_multipath_hash_policy=<span class="number">1</span></span><br></pre></td></tr></table></figure></li><li><p>在 BIRD 节点打流到 VIP</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1</span>..<span class="number">1000</span>&#125;; <span class="keyword">do</span> dig @<span class="number">10.0</span>.<span class="number">0.10</span> example.com; done</span><br></pre></td></tr></table></figure><p>查看两个 Coredns 节点日志，可以看到两节点平分了 VIP 的流量</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241209210934934.png" alt=""></p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;基于 FRRouting/Bird 配置多虚拟机之间的 OSPF 组网（建邻、路由交换），并实现多路径负载均衡。&lt;/p&gt;</summary>
    
    
    
    <category term="计算机网络" scheme="https://gy23333.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="FRRouting" scheme="https://gy23333.github.io/tags/FRRouting/"/>
    
    <category term="BIRD" scheme="https://gy23333.github.io/tags/BIRD/"/>
    
  </entry>
  
  <entry>
    <title>bird</title>
    <link href="https://gy23333.github.io/2024/12/03/bird/"/>
    <id>https://gy23333.github.io/2024/12/03/bird/</id>
    <published>2024-12-03T05:03:54.000Z</published>
    <updated>2024-12-09T13:14:57.909Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>bird</p><a id="more"></a><h1 id="安装-BIRD"><a href="#安装-BIRD" class="headerlink" title="安装 BIRD"></a>安装 BIRD</h1><p>Ubuntu 安装 bird</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bird2</span><br></pre></td></tr></table></figure><p>检查 bird 是否安装成功</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">guoyi@ubuntu2404:~<span class="variable">$</span> systemctl status bird</span><br><span class="line">● bird.service - BIRD Internet Routing Daemon</span><br><span class="line">     Loaded: loaded (/usr/lib/systemd/system/bird.service; enabled; preset: enabled)</span><br><span class="line">     Active: active (running) since Tue <span class="number">2024</span><span class="literal">-12</span><span class="literal">-03</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">57</span> UTC; <span class="number">5</span> days ago</span><br><span class="line">   Main PID: <span class="number">28186</span> (bird)</span><br><span class="line">      Tasks: <span class="number">1</span> (limit: <span class="number">4542</span>)</span><br><span class="line">     Memory: <span class="number">924.0</span>K (peak: <span class="number">1.9</span>M)</span><br><span class="line">        CPU: <span class="number">4.824</span>s</span><br><span class="line">     CGroup: /system.slice/bird.service</span><br><span class="line">             └─<span class="number">28186</span> /usr/sbin/bird <span class="operator">-f</span> <span class="literal">-u</span> bird <span class="literal">-g</span> bird</span><br><span class="line"></span><br><span class="line">Dec <span class="number">03</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">57</span> ubuntu2404 systemd[<span class="number">1</span>]: Starting bird.service - BIRD Internet Routing Daemon...</span><br><span class="line">Dec <span class="number">03</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">57</span> ubuntu2404 systemd[<span class="number">1</span>]: Started bird.service - BIRD Internet Routing Daemon.</span><br><span class="line">Dec <span class="number">03</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">57</span> ubuntu2404 (bird)[<span class="number">28186</span>]: bird.service: Referenced but unset environment variable evaluates to an emp&gt;</span><br><span class="line">Dec <span class="number">03</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">57</span> ubuntu2404 bird[<span class="number">28186</span>]: Chosen router ID <span class="number">172.16</span>.<span class="number">19.129</span> according to interface ens160</span><br><span class="line">Dec <span class="number">03</span> <span class="number">05</span>:<span class="number">05</span>:<span class="number">57</span> ubuntu2404 bird[<span class="number">28186</span>]: Started</span><br></pre></td></tr></table></figure><h1 id="birdc-命令"><a href="#birdc-命令" class="headerlink" title="birdc 命令"></a>birdc 命令</h1><p>通过 <code>birdc</code> 进入</p><ul><li><p>重新加载配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure</span><br></pre></td></tr></table></figure></li><li><p>查看路由</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show route</span><br></pre></td></tr></table></figure></li><li><p>查看 OSPF 邻居节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show ospf neighbors</span><br></pre></td></tr></table></figure></li></ul><h1 id="BIRD-配置"><a href="#BIRD-配置" class="headerlink" title="BIRD 配置"></a>BIRD 配置</h1><p>默认配置路径 <code>/etc/bird/bird.conf</code></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://bird.xmsl.dev" target="_blank" rel="noopener">BIRD 中文文档</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;bird&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>rp_filter反向路由过滤</title>
    <link href="https://gy23333.github.io/2024/11/22/rp-filter%E5%8F%8D%E5%90%91%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4/"/>
    <id>https://gy23333.github.io/2024/11/22/rp-filter%E5%8F%8D%E5%90%91%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4/</id>
    <published>2024-11-22T15:54:54.000Z</published>
    <updated>2024-11-24T18:37:03.879Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>Reverse Path Filtering，Linux 内核对接收到的数据包的反向路由校验过滤，主要用于防止 IP 地址欺骗攻击。本文主要介绍该校验机制、系统配置方式以及过滤包查看方法。</p><a id="more"></a><h1 id="反向路由校验机制"><a href="#反向路由校验机制" class="headerlink" title="反向路由校验机制"></a>反向路由校验机制</h1><p>反向路由校验，即在网卡收到数据包后，校验该数据包的反向路由是否匹配，如不匹配，则丢弃该包。具体流程如下：</p><ol><li>对于网卡收到的数据包，Linux 内核会检查该数据包的源 IP</li><li>参照当前的路由表，判断如以该数据包的源 IP 作为目的 IP，返回路径的路由选择是否与当前接收接口一致</li><li>如不一致，则认为该数据包可能是伪造的，丢弃该数据包</li></ol><p>如下图，eth1 网卡开启了严格的 rp_filter 检查，此时 eth1 网卡收到源 IP 为 <code>172.16.19.24</code> 的包，rp_filter 检查如果以 <code>172.16.19.24</code> 为目的 IP，根据路由表，匹配的网卡应该为 eth0，而不是收到包的 eth1，因此判断该数据包可能伪造源 IP，丢弃该包。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241124140220970.png" alt="image-20241124140220970" style="zoom: 50%;" /></p><h1 id="Linux-内核参数"><a href="#Linux-内核参数" class="headerlink" title="Linux 内核参数"></a>Linux 内核参数</h1><h2 id="net-ipv4-conf-XXX-rp-filter"><a href="#net-ipv4-conf-XXX-rp-filter" class="headerlink" title="net.ipv4.conf.XXX.rp_filter"></a><code>net.ipv4.conf.XXX.rp_filter</code></h2><p><a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/networking/ip-sysctl.txt?h=v4.9#n1090" target="_blank" rel="noopener">Linux 内核参数详解</a></p><p>rp_filter 为 Linux 用于设置反向路由校验机制的内核参数，共有三种可配置值 0、1、2，</p><ul><li><code>rp_filter = 0</code>：关闭反向路由校验。</li><li><code>rp_filter = 1</code>：开启严格的反向路由校验。如果反向路由不是最佳路由，则丢弃该包。</li><li><code>rp_filter = 2</code>：开启松散的反向路由校验。对于收到的数据包，只检查其源 IP 是否可达，即反向路由是否可通（任意网卡均可），如果反向路径不通，则丢弃该包。</li></ul><p>rp_filter 分为三类：<code>all</code>、<code>default</code>、特定网卡。</p><ul><li><code>default</code> 用于生成网卡时设置默认的 rp_filter 值</li><li>每张网卡的 rp_filter 取 <code>conf/{all,interface}/rp_filter</code> 中的最大值</li></ul><p>如下面配置，eth0 的 rp_filter 为 1（取 all 和 eth0 中的最大值），eth1 的 rp_filter 为 2（取 all 和 eth1 中的最大值）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.all.rp_filter = <span class="number">1</span></span><br><span class="line">net.ipv4.conf.eth0.rp_filter = <span class="number">0</span></span><br><span class="line">net.ipv4.conf.eth1.rp_filter = <span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="查看-rp-filter"><a href="#查看-rp-filter" class="headerlink" title="查看 rp_filter"></a>查看 rp_filter</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:~<span class="comment"># sysctl -a | grep rp_filter</span></span><br><span class="line">net.ipv4.conf.all.rp_filter = <span class="number">2</span></span><br><span class="line">net.ipv4.conf.default.rp_filter = <span class="number">2</span></span><br><span class="line">net.ipv4.conf.ens160.rp_filter = <span class="number">2</span></span><br><span class="line">net.ipv4.conf.ens256.rp_filter = <span class="number">2</span></span><br><span class="line">net.ipv4.conf.lo.rp_filter = <span class="number">0</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="设置-rp-filter"><a href="#设置-rp-filter" class="headerlink" title="设置 rp_filter"></a>设置 rp_filter</h2><p>临时设置（重启后失效）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:~<span class="comment"># sysctl -w net.ipv4.conf.ens160.rp_filter=1</span></span><br><span class="line">net.ipv4.conf.ens160.rp_filter = <span class="number">1</span></span><br></pre></td></tr></table></figure><h1 id="tcpdump-与-rp-filter"><a href="#tcpdump-与-rp-filter" class="headerlink" title="tcpdump 与 rp_filter"></a>tcpdump 与 rp_filter</h1><p><strong>tcpdump 依旧可以抓到被 rp_filter 过滤掉的包。</strong></p><p>下图的五层网络分层模型中，收包是从下到上，发包是从上到下。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241125012534947.png" alt="image-20241125012534947" style="zoom:50%;" /></p><p>tcpdump 运行在链路层的网络设备层，而 rp_filter 运行在协议栈的网络层，对于收包流程来说，tcpdump 先于 rp_filter 进行，所以即使数据包会被 rp_filter 过滤掉，依旧可以通过 tcpdump 抓到该数据包。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241125013945101.png" alt="image-20241125013945101" style="zoom:50%;" /></p><h1 id="rp-filter-日志"><a href="#rp-filter-日志" class="headerlink" title="rp_filter 日志"></a>rp_filter 日志</h1><p>默认情况下，内核并不会记录被 rp_filter 过滤掉的包，但可以通过 iptables 添加日志规则，模拟和预测哪些包会被 rp_filter 丢弃。</p><p>添加 iptables 日志规则（如需删除，则把其中的 <code>-A</code> 改成 <code>-D</code>）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables <span class="literal">-t</span> raw <span class="literal">-A</span> PREROUTING <span class="literal">-m</span> rpfilter -<span class="literal">-invert</span> <span class="literal">-j</span> LOG -<span class="literal">-log</span><span class="literal">-prefix</span> <span class="string">"RP_FILTER_DROP: "</span></span><br></pre></td></tr></table></figure><p>查看添加的 iptables 日志规则</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:~<span class="comment"># iptables -t raw -L PREROUTING -v</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT <span class="number">299</span> packets, <span class="number">20976</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     source               destination</span><br><span class="line">  <span class="number">299</span> <span class="number">20976</span> LOG        all  --  any    any     anywhere             anywhere             rpfilter invert LOG level warn prefix <span class="string">"RP_FILTER_DROP: "</span></span><br></pre></td></tr></table></figure><p>查看内核日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg -T | grep &quot;RP_FILTER_DROP&quot;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:~<span class="comment"># dmesg -T | grep "RP_FILTER_DROP" | tail -20</span></span><br><span class="line">[<span class="type">Sun</span> <span class="type">Nov</span> <span class="number">24</span> <span class="number">18</span>:<span class="number">27</span>:<span class="number">49</span> <span class="number">2024</span>] RP_FILTER_DROP: <span class="keyword">IN</span>=ens256 OUT= MAC=<span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">48</span>:<span class="number">8</span>d:<span class="number">03</span>:ae:<span class="number">07</span>:<span class="number">75</span>:<span class="number">50</span>:<span class="number">39</span>:<span class="number">65</span>:<span class="number">08</span>:<span class="number">00</span> SRC=<span class="number">172.16</span>.<span class="number">19.1</span> DST=<span class="number">172.16</span>.<span class="number">19.129</span> LEN=<span class="number">88</span> TOS=<span class="number">0</span>x0A PREC=<span class="number">0</span>x40 TTL=<span class="number">64</span> ID=<span class="number">0</span> DF PROTO=TCP SPT=<span class="number">60402</span> DPT=<span class="number">22</span> WINDOW=<span class="number">2048</span> RES=<span class="number">0</span>x00 ACK PSH URGP=<span class="number">0</span></span><br><span class="line">[<span class="type">Sun</span> <span class="type">Nov</span> <span class="number">24</span> <span class="number">18</span>:<span class="number">27</span>:<span class="number">49</span> <span class="number">2024</span>] RP_FILTER_DROP: <span class="keyword">IN</span>=ens256 OUT= MAC=<span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">48</span>:<span class="number">8</span>d:<span class="number">03</span>:ae:<span class="number">07</span>:<span class="number">75</span>:<span class="number">50</span>:<span class="number">39</span>:<span class="number">65</span>:<span class="number">08</span>:<span class="number">00</span> SRC=<span class="number">172.16</span>.<span class="number">19.1</span> DST=<span class="number">172.16</span>.<span class="number">19.129</span> LEN=<span class="number">52</span> TOS=<span class="number">0</span>x08 PREC=<span class="number">0</span>x40 TTL=<span class="number">64</span> ID=<span class="number">0</span> DF PROTO=TCP SPT=<span class="number">60402</span> DPT=<span class="number">22</span> WINDOW=<span class="number">2047</span> RES=<span class="number">0</span>x00 ACK URGP=<span class="number">0</span></span><br><span class="line">[<span class="type">Sun</span> <span class="type">Nov</span> <span class="number">24</span> <span class="number">18</span>:<span class="number">27</span>:<span class="number">49</span> <span class="number">2024</span>] RP_FILTER_DROP: <span class="keyword">IN</span>=ens256 OUT= MAC=<span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">48</span>:<span class="number">8</span>d:<span class="number">03</span>:ae:<span class="number">07</span>:<span class="number">75</span>:<span class="number">50</span>:<span class="number">39</span>:<span class="number">65</span>:<span class="number">08</span>:<span class="number">00</span> SRC=<span class="number">172.16</span>.<span class="number">19.1</span> DST=<span class="number">172.16</span>.<span class="number">19.129</span> LEN=<span class="number">88</span> TOS=<span class="number">0</span>x0A PREC=<span class="number">0</span>x40 TTL=<span class="number">64</span> ID=<span class="number">0</span> DF PROTO=TCP SPT=<span class="number">60402</span> DPT=<span class="number">22</span> WINDOW=<span class="number">2048</span> RES=<span class="number">0</span>x00 ACK PSH URGP=<span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Reverse Path Filtering，Linux 内核对接收到的数据包的反向路由校验过滤，主要用于防止 IP 地址欺骗攻击。本文主要介绍该校验机制、系统配置方式以及过滤包查看方法。&lt;/p&gt;</summary>
    
    
    
    <category term="计算机网络" scheme="https://gy23333.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="计算机网络" scheme="https://gy23333.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    <category term="Linux" scheme="https://gy23333.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Go调试器:Delve</title>
    <link href="https://gy23333.github.io/2024/11/19/Go%E8%B0%83%E8%AF%95%E5%99%A8-Delve/"/>
    <id>https://gy23333.github.io/2024/11/19/Go%E8%B0%83%E8%AF%95%E5%99%A8-Delve/</id>
    <published>2024-11-18T17:06:33.000Z</published>
    <updated>2024-11-18T18:39:29.113Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>Go调试器:Delve</p><a id="more"></a><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install github.com&#x2F;go-delve&#x2F;delve&#x2F;cmd&#x2F;dlv@latest</span><br></pre></td></tr></table></figure><p>检查安装是否成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dlv version</span><br></pre></td></tr></table></figure><h1 id="进入调试"><a href="#进入调试" class="headerlink" title="进入调试"></a>进入调试</h1><ul><li><p>调试源文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dlv debug main.go</span><br></pre></td></tr></table></figure></li><li><p>调试可执行文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dlv exec .&#x2F;main</span><br></pre></td></tr></table></figure></li><li><p>调试进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dlv attach &lt;PROCESS_ID&gt;</span><br></pre></td></tr></table></figure></li></ul><h1 id="调试命令"><a href="#调试命令" class="headerlink" title="调试命令"></a>调试命令</h1><p>可以通过 <code>help</code> 查看所有命令</p><h2 id="运行程序"><a href="#运行程序" class="headerlink" title="运行程序"></a>运行程序</h2><div class="table-container"><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>call</code></td><td style="text-align:left">恢复进程，调用函数 (实验阶段)</td></tr><tr><td style="text-align:left"><code>continue</code>(<code>c</code>)</td><td style="text-align:left">继续运行程序，直到遇到断点或程序结束</td></tr><tr><td style="text-align:left"><code>next</code>(<code>n</code>)</td><td style="text-align:left">单步调试（跳过函数内部）</td></tr><tr><td style="text-align:left"><code>step</code>(<code>s</code>)</td><td style="text-align:left">单步调试（进入函数内部）</td></tr><tr><td style="text-align:left"><code>restart</code>(<code>r</code>)</td><td style="text-align:left">重新运行</td></tr><tr><td style="text-align:left"><code>stepout</code>(<code>so</code>)</td><td style="text-align:left">从当前函数跳出</td></tr></tbody></table></div><h2 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h2><div class="table-container"><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>break</code>(<code>b</code>)</td><td style="text-align:left">设置断点</td></tr><tr><td style="text-align:left"><code>breakpoints</code>(<code>bp</code>)</td><td style="text-align:left">打印所有断点</td></tr><tr><td style="text-align:left"><code>clear</code></td><td style="text-align:left">删除断点</td></tr><tr><td style="text-align:left"><code>clearall</code></td><td style="text-align:left">删除所有断点</td></tr><tr><td style="text-align:left"><code>condition</code></td><td style="text-align:left">设置条件断点</td></tr><tr><td style="text-align:left"><code>on</code></td><td style="text-align:left">设置一个断点触发时执行的命令</td></tr><tr><td style="text-align:left"><code>toggle</code></td><td style="text-align:left">打开/关闭 断点</td></tr></tbody></table></div><h2 id="查看变量"><a href="#查看变量" class="headerlink" title="查看变量"></a>查看变量</h2><div class="table-container"><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>args</code></td><td style="text-align:left">打印函数参数</td></tr><tr><td style="text-align:left"><code>display</code></td><td style="text-align:left">每次程序停止时打印表达式的值</td></tr><tr><td style="text-align:left"><code>examinemem</code></td><td style="text-align:left">解析给定地址的内存</td></tr><tr><td style="text-align:left"><code>locals</code></td><td style="text-align:left">打印本地变量</td></tr><tr><td style="text-align:left"><code>print</code>(<code>p</code>)</td><td style="text-align:left">解析一个表达式</td></tr><tr><td style="text-align:left"><code>regs</code></td><td style="text-align:left">打印寄存器信息</td></tr><tr><td style="text-align:left"><code>set</code></td><td style="text-align:left">设置变量的值</td></tr><tr><td style="text-align:left"><code>vars</code></td><td style="text-align:left">打印包内变量</td></tr><tr><td style="text-align:left"><code>whatis</code></td><td style="text-align:left">打印类型信息</td></tr></tbody></table></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;Go调试器:Delve&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>算法题</title>
    <link href="https://gy23333.github.io/2024/11/17/%E7%AE%97%E6%B3%95%E9%A2%98/"/>
    <id>https://gy23333.github.io/2024/11/17/%E7%AE%97%E6%B3%95%E9%A2%98/</id>
    <published>2024-11-17T14:58:09.000Z</published>
    <updated>2024-11-17T15:16:21.459Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>LeetCode Go 刷题记录</p><a id="more"></a><h1 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h1><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://leetcode.cn/circle/discuss/E3yavq/" target="_blank" rel="noopener">[力扣刷题攻略] Re：从零开始的力扣刷题生活</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;LeetCode Go 刷题记录&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://gy23333.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="算法" scheme="https://gy23333.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>一致性哈希算法</title>
    <link href="https://gy23333.github.io/2024/11/07/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/"/>
    <id>https://gy23333.github.io/2024/11/07/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/</id>
    <published>2024-11-06T16:09:44.000Z</published>
    <updated>2024-11-12T18:01:02.564Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>一致性哈希，Consistent Hashing，用于分布式系统的负载均衡，解决了传统哈希算法的节点扩缩容问题。</p><a id="more"></a><h1 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h1><p>在分布式系统中，集群由多台服务器组成，数据采用分布式缓存，期望将数据尽量均匀地分配缓存到各个服务器，每个服务器上有着不同的缓存，以分担压力。请求数据时，再到相应的服务器获取缓存。这部分工作由负载均衡层 LB 来完成。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241107021347734.png" alt="image-20241107021347734" style="zoom:50%;" /></p><p>分布式系统应满足下面要求：</p><ul><li>对于同一个数据的请求落在相同的服务器上</li><li>数据分配尽量均匀</li><li>当服务器数量增减时，尽量减小原有数据分配变化</li></ul><h1 id="传统哈希算法"><a href="#传统哈希算法" class="headerlink" title="传统哈希算法"></a>传统哈希算法</h1><h2 id="传统哈希算法-1"><a href="#传统哈希算法-1" class="headerlink" title="传统哈希算法"></a>传统哈希算法</h2><p>哈希算法采用取模运算，基于下面的公式，将 hash 值对机器数量取余，将数据的 key 映射到节点。</p><script type="math/tex; mode=display">hash(key) \% size</script><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241107131915573.png" alt="image-20241107131915573" style="zoom:50%;" /></p><h2 id="扩缩容问题"><a href="#扩缩容问题" class="headerlink" title="扩缩容问题"></a>扩缩容问题</h2><p>服务器集群会因为业务量变化需求而扩缩容，增加或减少节点数，此时映射关系发生大量变化，缓存失效，需要进行数据迁移，以保证请求正常。数据迁移规模 <code>O(M)</code>，迁移成本极大，导致服务器瞬时压力巨大。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241107132455997.png" alt="image-20241107132455997" style="zoom:50%;" /></p><h1 id="一致性哈希算法"><a href="#一致性哈希算法" class="headerlink" title="一致性哈希算法"></a>一致性哈希算法</h1><h2 id="哈希环"><a href="#哈希环" class="headerlink" title="哈希环"></a>哈希环</h2><p>一致性哈希算法引入哈希环解决了扩缩容导致过多数据迁移问题。</p><p>一致性哈希算法同样采用了取模的方式，但与传统哈希不同，取模值固定为 $2^{32}$</p><script type="math/tex; mode=display">hash(key) \% 2^{32}</script><p>可以把取模结果当做一个圆环，由 $2^{32}$ 个点组成，先将服务器取模映射到哈希环上，再将数据同样取模映射到环上，选择顺时针找到的第一个服务器存入。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241107134652765.png" alt="image-20241107134652765" style="zoom:50%;" /></p><p>此时添加一个节点，仅有少量的数据需要重新分配映射，大部分位置分配保持不变。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241107135232078.png" alt="image-20241107135232078" style="zoom:50%;" /></p><h2 id="虚拟节点"><a href="#虚拟节点" class="headerlink" title="虚拟节点"></a>虚拟节点</h2><p>如果采用节点直接映射，可能存在节点分布不均匀问题，也就是 hash 偏斜。大部分的缓存落在少数几台服务器上，如果该台服务器发生故障，会导致瞬时大量数据迁移。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241113013903066.png" alt="image-20241113013903066" style="zoom:60%;" /></p><p>为了解决 hash 偏斜问题，引入虚拟节点。</p><p>将每个服务器映射为多个虚拟节点，数量足够多，以保证均匀分布。数据映射时先找到虚拟节点，再对应到相应的真实节点。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241113015419128.png" alt="image-20241113015419128" style="zoom:50%;" /></p><h1 id="Go-实现一致性哈希"><a href="#Go-实现一致性哈希" class="headerlink" title="Go 实现一致性哈希"></a>Go 实现一致性哈希</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;一致性哈希，Consistent Hashing，用于分布式系统的负载均衡，解决了传统哈希算法的节点扩缩容问题。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Load Balancing" scheme="https://gy23333.github.io/tags/Load-Balancing/"/>
    
  </entry>
  
  <entry>
    <title>BGP 路由协议</title>
    <link href="https://gy23333.github.io/2024/10/23/BGP-%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE/"/>
    <id>https://gy23333.github.io/2024/10/23/BGP-%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE/</id>
    <published>2024-10-22T18:38:51.000Z</published>
    <updated>2024-11-11T03:57:58.125Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>BGP 路由协议</p><a id="more"></a><h1 id="BGP-路由选择策略"><a href="#BGP-路由选择策略" class="headerlink" title="BGP 路由选择策略"></a>BGP 路由选择策略</h1><p>对于同一个目的地址，路由器会收到多个路径，BGP 对这些路径进行选择分类，决定最终的路由选择</p><ul><li>Available：可用路径<ul><li>所有合法的可用路径</li></ul></li><li>Best：最佳路径<ul><li>通过 BGP 最佳路由选择策略，选出来的唯一一个路由，作为最佳路由</li></ul></li><li>Select：选择路径<ul><li>在 BGP 最佳路由选择策略中，前 8 步都与 Best Path 属性相同的路径</li><li>这些 Select Path 将会加入路由表，实现 BGP 负载均衡</li></ul></li></ul><h2 id="BGP-最佳路由选择策略"><a href="#BGP-最佳路由选择策略" class="headerlink" title="BGP 最佳路由选择策略"></a>BGP 最佳路由选择策略</h2><p>当路由器收到到同一个目的地址的多个 Available Path，BGP 最佳路由选择策略从中选出一条 Best Path。</p><p>以下是 BGP 最佳路径选择策略，按比较顺序排列：</p><ol><li><strong>优选权重（Weight）最高的路径</strong></li><li><strong>优选本地优先级（Local Preference）最高的路径</strong></li><li><strong>优选起本地生成的路径</strong><ul><li>本地内部生成的路由优先级高于从外部学到的路由</li><li>本地生成的路由，即通过<code>network</code>命令或<code>aggregate</code>命令手动注入的路由</li></ul></li><li><strong>优选 AS Path 长度最短的路径</strong><ul><li>AS Path：一个路由经过的自治系统（AS）序列</li><li>优先级比较 AS Path 长度，而非 AS Path 本身<ul><li>路径 1 的 AS Path：<code>65005 65004 65003</code></li><li>路径 2 的 AS Path：<code>65006 65003</code></li><li>只比较两者的长度，路径 1 长度为 3，路径 2 长度为 2，优选路径 2</li></ul></li></ul></li><li><strong>优选 Origin Type 优先级最高的路径</strong><ul><li>Origin Type 用于表示路由来源类型，共有三种：<ul><li>IGP：内部网关协议，Internal Gateway Protocol</li><li>EGP：外部网关协议，Exterior Gateway Protocol</li><li>Incomplete：不确定来源</li></ul></li><li>优先级 IGP &gt; EGP &gt; Incomplete</li></ul></li><li><strong>优选 MED 最小的路径</strong><ul><li>MED，Multi-Exit Discriminator，多出口鉴别，只在两个 AS 之间交换，不会传到第三个 AS</li><li>两个 AS 之间可能有多条链路连接，MED 用于决定选择那条链路</li><li>MED 默认值：0</li></ul></li><li><strong>优选邻居路由器类型为 eBGP 先于 iBGP</strong><ul><li>eBGP，external BGP，外部 BGP，不同 AS 之间的 BGP</li><li>iBGP，internal BGP，内部 BGP，相同 AS 内部的 BGP</li><li>优选 eBGP 路由器，即优选跨 AZ 路径，到达这一步比较的路由，如同时有 eBGP 和 iBGP 路径，iBGP 路径是经过了内部转发再到 eBGP 路由器的绕行路径，所以优选直接到 eBGP 路由器的路径</li></ul></li><li><strong>优选到 BGP next hop 的 IGP 度量值最小的路径</strong><ul><li>IGP metric，内部路由度量值，在第七步中选择 iBGP 才需要比较步骤，否则跳过</li><li>IGP 越小，则去该下一跳的开销越小</li><li><strong>到该步如存在多个路径条件都相同，则 BGP 负载均衡</strong></li></ul></li><li><strong>优选来自 Route ID 最小的路由器的路径</strong></li><li><strong>优选 Cluster List 最短的路径</strong></li><li><strong>优选来自 IP 地址最小的 Neighbor 的路径</strong></li></ol><h2 id="BGP-负载均衡"><a href="#BGP-负载均衡" class="headerlink" title="BGP 负载均衡"></a>BGP 负载均衡</h2><p>BGP Multipath 允许给一个目的地址加载多个 BGP 路径到 IP 路由表，这些路由实现 BGP 负载均衡。这不影响上步中的 Best Path 的选择，依旧从多个路径中选择一条路径作为 Best Path。在此基础之上，可以选取多个路径作为 Select Path，一同加入路由表，实现多路径负载均衡。</p><ul><li>Select Path 在路由选择策略中的前 8 步必须与 Best Path 完全相同，即有相同的 Weight、Local Preference、AS Path length、Origin Type、MED、eBGP/iBGP、IGP Metric</li><li>Best Path 必然包含在 Select Path 中</li><li><code>maximum-paths</code> 设置 BGP 最多允许的 Select Path 数量，如果设置为 1，则 Select Path 只能有一个，也就是 Best Path</li></ul><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13753-25.html" target="_blank" rel="noopener">Select BGP Best Path Algorithm</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;BGP 路由协议&lt;/p&gt;</summary>
    
    
    
    <category term="计算机网络" scheme="https://gy23333.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="计算机网络" scheme="https://gy23333.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    <category term="路由协议" scheme="https://gy23333.github.io/tags/%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE/"/>
    
    <category term="BGP" scheme="https://gy23333.github.io/tags/BGP/"/>
    
  </entry>
  
  <entry>
    <title>systemd</title>
    <link href="https://gy23333.github.io/2024/10/05/systemd/"/>
    <id>https://gy23333.github.io/2024/10/05/systemd/</id>
    <published>2024-10-05T12:20:32.000Z</published>
    <updated>2024-11-11T03:57:58.130Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>systemd 是 Linux 的系统和服务管理器。作为系统启动的第一个进程，初始化系统并且管理其他用户服务。</p><a id="more"></a><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>systemd 提供了一套完整的系统启动和管理的解决方案，其中的 <code>d</code> 为守护进程（daemon）的缩写，即系统的守护进程。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/bg2016030703.png" alt="systemd架构图"></p><p>查看 systemd 简介</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man systemd</span><br></pre></td></tr></table></figure><p>systemd 作为系统的第一个进程，PID = 1，其余所有进程都是 systemd 的子进程。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># pstree -p</span></span><br><span class="line">systemd(<span class="number">1</span>)─┬─ModemManager(<span class="number">855</span>)─┬─&#123;ModemManager&#125;(<span class="number">887</span>)</span><br><span class="line">           │                   └─&#123;ModemManager&#125;(<span class="number">894</span>)</span><br><span class="line">           ├─NetworkManager(<span class="number">777</span>)─┬─&#123;NetworkManager&#125;(<span class="number">854</span>)</span><br><span class="line">           │                     └─&#123;NetworkManager&#125;(<span class="number">859</span>)</span><br><span class="line">           ├─VGAuthService(<span class="number">747</span>)</span><br><span class="line">           ├─accounts<span class="literal">-daemon</span>(<span class="number">766</span>)─┬─&#123;accounts<span class="literal">-daemon</span>&#125;(<span class="number">778</span>)</span><br><span class="line">           │                      └─&#123;accounts<span class="literal">-daemon</span>&#125;(<span class="number">811</span>)</span><br><span class="line">           ├─acpid(<span class="number">767</span>)</span><br><span class="line">           ├─avahi<span class="literal">-daemon</span>(<span class="number">770</span>)───avahi<span class="literal">-daemon</span>(<span class="number">840</span>)</span><br><span class="line">           ├─bluetoothd(<span class="number">771</span>)</span><br><span class="line">           ├─colord(<span class="number">1484</span>)─┬─&#123;colord&#125;(<span class="number">1486</span>)</span><br><span class="line">           │              └─&#123;colord&#125;(<span class="number">1488</span>)</span><br><span class="line">           ├─cron(<span class="number">773</span>)</span><br><span class="line">        .....</span><br></pre></td></tr></table></figure><h1 id="Unit"><a href="#Unit" class="headerlink" title="Unit"></a>Unit</h1><p>systemd 可以管理所有系统资源，unit 为 systemd 的基本管理单元，用于描述系统服务、资源、设备和其他对象，根据不同资源分为了 12 种 Unit。</p><ul><li>Service unit：系统服务</li><li>Target unit：多个 Unit 构成的一个组</li><li>Device Unit：硬件设备</li><li>Mount Unit：文件系统的挂载点</li><li>Automount Unit：自动挂载点</li><li>Path Unit：文件或路径</li><li>Scope Unit：不是由 Systemd 启动的外部进程</li><li>Slice Unit：进程组</li><li>Snapshot Unit：Systemd 快照，可以切回某个快照</li><li>Socket Unit：进程间通信的 socket</li><li>Swap Unit：swap 文件</li><li>Timer Unit：定时器</li></ul><p>可通过 <code>man systemd.service</code> 查看各种 Unit 的简介。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>每个 Unit 需设置对应类型的配置文件。Unit 配置分为三个区块：Unit、Service\Timer\Socket、Install</p><h3 id="Unit-区块"><a href="#Unit-区块" class="headerlink" title="Unit 区块"></a>Unit 区块</h3><p>Unit 的元数据，定义了 unit 的基本信息、依赖关系和启动顺序。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=服务或单元的描述</span><br><span class="line"><span class="attr">Documentation</span>=man:your-man-page(<span class="number">1</span>)  <span class="comment"># 可选，文档链接</span></span><br><span class="line"><span class="attr">Requires</span>=其他-unit.service  <span class="comment"># 可选，定义强依赖</span></span><br><span class="line"><span class="attr">Wants</span>=其他-unit.service  <span class="comment"># 可选，定义弱依赖</span></span><br><span class="line"><span class="attr">After</span>=network.target  <span class="comment"># 可选，指定启动顺序</span></span><br><span class="line"><span class="attr">Before</span>=其他-unit.service  <span class="comment"># 可选，指定启动顺序</span></span><br></pre></td></tr></table></figure><ul><li><code>Description</code>：简短描述</li><li><code>Documentation</code>：文档地址，可以是手册页或 URL</li></ul><p><strong>依赖关系</strong></p><p>例如：unit-A Requires/BindsTo/Wants/PartOf=unit-B.service</p><ul><li><code>Requires</code>：<ul><li>强依赖</li><li>unit-A 启动时，自动启动被依赖 unit-B，如果被依赖 unit-B 启动失败，则该 unit-A 也会启动失败</li></ul></li><li><code>BindsTo</code>：<ul><li>强依赖</li><li>unit-A 启动时，自动启动被依赖 unit-B，如果被依赖 unit-B 启动失败，则该 unit-A 也会启动失败</li><li>unit-B 停止或者失败时，依赖 unit-B 的 unit-A 也会自动停止 </li></ul></li><li><code>Wants</code>：<ul><li>弱依赖</li><li>unit-A 启动时，自动启动被依赖 unit-B，但被依赖 unit-B 启动失败，也不会一些该 unit-A 启动</li></ul></li></ul><div class="table-container"><table><thead><tr><th>特性</th><th><code>Requires</code></th><th><code>BindsTo</code></th><th><code>Wants</code></th></tr></thead><tbody><tr><td>启动行为</td><td>必须成功启动被依赖的 unit</td><td>必须成功启动被依赖的 unit</td><td>建议启动被依赖的 unit</td></tr><tr><td>停止行为</td><td>不会自动停止依赖它的 unit</td><td>自动停止依赖它的 unit</td><td>不会自动停止依赖它的 unit</td></tr><tr><td>依赖关系类型</td><td>单向强依赖</td><td>双向强依赖</td><td>弱依赖</td></tr><tr><td>适用场景</td><td>功能密切相关但生命周期不必一致的服务</td><td>需要同时运行并在同一生命周期内运行的服务</td><td>可能相互关联但非必需的服务</td></tr></tbody></table></div><ul><li><code>Conflicts</code>：互斥关系，unit-A 和 unit-B 不能同时运行，当 unit-A 启动时，会自动停止 unit-B，反之亦然</li><li><code>PartOf</code>：unit-A 是目标服务 unit-B 的一部分，当目标服务 unit-B 停止或被重启时，作为其一部分的 unit-A 也会停止或重启</li></ul><p><strong>启动顺序</strong></p><p>例如：unit-A Before/After=unit-B.service</p><ul><li><code>Before</code>：当前 unit A 应该在指定的 unit B 之前启动（A -&gt; B）</li><li><code>After</code>：当前 unit A 应该在指定的 unit B 之后启动（B -&gt; A）</li></ul><p>顺序配置<code>Before</code>、<code>After</code> 只是设置一起启动时的顺序，A 服务启动时并不会自动启动 B 服务，如需设置自启动，需搭配依赖关系使用。</p><p><strong>其他关系</strong></p><ul><li><code>Condition...</code>：检查服务启动时的条件，如果条件不满足，服务将不会被启动，但不会导致启动失败<ul><li><code>ConditionPathExists=</code>：检查指定的文件或路径是否存在。如果路径存在，服务将启动</li><li><code>ConditionPathExistsGlob=</code>：使用通配符检查路径是否匹配</li><li><code>ConditionPathIsDirectory=</code>：检查指定路径是否是一个目录</li><li><code>ConditionPathIsSymbolicLink=</code>：检查指定路径是否是一个符号链接</li><li><code>ConditionKernelCommandLine=</code>：检查内核命令行参数是否包含指定的字符串</li><li><code>ConditionVirtualization=</code>：检查当前系统是否运行在虚拟化环境中（如 KVM、LXC 等）</li><li><code>ConditionHost=</code>：检查主机名是否与指定值匹配</li></ul></li><li><code>Assert...</code>：对服务启动的条件进行强制检查。与 <code>Condition</code> 不同，如果指定的条件未满足，服务将不会启动，且系统会报告错误<ul><li><code>AssertPathExists=</code>：检查指定路径是否存在</li><li><code>AssertPathIsDirectory=</code>：检查指定路径是否是目录</li><li><code>AssertPathIsSymbolicLink=</code>：检查指定路径是否是符号链接</li><li><code>AssertKernelCommandLine=</code>：检查内核命令行参数</li><li><code>AssertVirtualization=</code>：检查当前系统是否在虚拟化环境中</li></ul></li></ul><h3 id="类型区块"><a href="#类型区块" class="headerlink" title="类型区块"></a>类型区块</h3><h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p><code>systemd.service</code> 是用于定义和管理系统服务的单位类型。</p><p>配置文件以 <code>.service</code> 结尾，主要用于描述如何启动、停止和管理服务。</p><p><code>.service</code> 配置中，通过 [Service] 区块定义服务的启动和运行参数。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/default/ssh</span><br><span class="line"><span class="attr">ExecStartPre</span>=/usr/sbin/sshd -t</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/sbin/sshd -D <span class="variable">$SSHD_OPTS</span></span><br><span class="line"><span class="attr">ExecReload</span>=/usr/sbin/sshd -t</span><br><span class="line"><span class="attr">ExecReload</span>=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">KillMode</span>=process</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartPreventExitStatus</span>=<span class="number">255</span></span><br><span class="line"><span class="attr">RuntimeDirectory</span>=sshd</span><br><span class="line"><span class="attr">RuntimeDirectoryMode</span>=<span class="number">0755</span></span><br></pre></td></tr></table></figure><p><strong>启动类型</strong></p><ul><li><code>Type</code>：配置服务如何通知systemd服务启动完成<ul><li><code>simple</code>（默认值）：systemd 调用完 <code>ExecStart</code> 后即认为服务启动成功，即使 <code>ExecStart</code> 运行失败，服务也启动成功</li><li><code>notify</code>：启动时，服务通过 <code>sd_notify()</code> 发送一个 “READY=1” 信号，systemd 收到这个信号后才认为服务启动成功，再启动之后的 unit</li><li><code>dbus</code>：需设置 <code>BusName=</code>（如设置，自动为 dbus 类型），当 systemd 确认 <code>BusName=</code> 的 dbus 存在后，则认为服务启动成功</li><li>等等</li></ul></li></ul><p><strong>启动命令</strong></p><ul><li><p><code>EnvironmentFile</code>：启动时会加载这个配置的环境变量文件</p></li><li><p><code>ExecStartPre</code>：启动服务之前执行的命令</p><ul><li><p>如果 <code>ExecStartPre</code> 执行失败，则服务启动失败，不会执行 <code>ExecStart</code></p></li><li><p>如果希望 <code>ExecStartPre</code> 执行失败也能继续执行 <code>ExecStart</code>，需在 <code>ExecStartPre</code> 加前缀 <code>-</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ExecStartPre</span>=-/usr/bin/check_dependencies</span><br></pre></td></tr></table></figure></li><li><p>支持多个 <code>ExecStartPre</code>，按顺序执行</p></li></ul></li><li><p><code>ExecStart</code>（必选）：启动服务执行的命令</p></li><li><p><code>ExecStartPost</code>：启动服务成功之后执行的命令</p><ul><li>如果 <code>Type</code> 规定的启动没成功，则不会执行 <code>ExecStartPost</code></li></ul></li></ul><p><strong>终止类型</strong></p><ul><li><code>KillMode</code>：停止服务时如何处理进程<ul><li><code>control-group</code>（默认值）：停止服务时，所有属于该服务 cgroup 的所有进程都会被杀死</li><li><code>process</code>：停止服务时，只杀主进程，主进程产生的子进程不会被杀死</li><li><code>mixed</code>：停止服务时，向主进程发送 SIGTERM 信号，接着向子进程发送 SIGKILL 信号</li><li><code>none</code>：没有进程会被杀掉，只是执行服务的 <code>ExecStop</code> 命令</li></ul></li></ul><blockquote><p>杀进程过程：</p><ol><li>向进程发送<code>KillSignal=</code> 信号（默认为 <code>SIGTERM</code>）</li><li>等待进程被杀死</li><li>若等候 <code>TimeoutStopSec=</code> 时间（默认 90s）后，进程仍然未被杀死，向进程发送 <code>FinalKillSignal=</code> 信号（默认为 <code>SIGKILL</code>）强制杀死进程</li></ol></blockquote><p><strong>终止命令</strong></p><ul><li><code>ExecStop</code>字段：停止服务时执行的命令</li><li><code>ExecStopPost</code>字段：停止服务之后执行的命令</li></ul><p><strong>重启类型</strong></p><p>有时候，服务需要保持运行状态，如有意外奔溃，能自动拉起，可通过下面配置设置自拉起</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Restart&#x3D;always</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">StartLimitInterval&#x3D;0</span><br></pre></td></tr></table></figure><ul><li><code>Restart</code>：重启机制，什么情况下会自动触发重启服务（systemctl stop/restart 触发的停止服务，不会被这里设置的重启机制拉起）<ul><li>no（默认值）：退出后不会重启</li><li>always：所有情况触发自动重启</li><li>on-success：只有正常退出时触发自动重启</li><li>on-failure：异常退出时触发自动重启</li><li>on-abnormal：只有被信号终止和超时，才会重启</li><li>on-abort：只有在收到没有捕捉到的信号终止时，才会重启</li><li>on-watchdog：超时退出，才会重启</li></ul></li></ul><div class="table-container"><table><thead><tr><th>退出原因</th><th>no</th><th>always</th><th>on-success</th><th>on-failure</th><th>on-abnormal</th><th>on-abort</th><th>on-watchdog</th></tr></thead><tbody><tr><td>systemctl stop</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>正常退出</td><td></td><td>restart</td><td>restart</td><td></td><td></td><td></td><td></td></tr><tr><td>退出码不为“0”</td><td></td><td>restart</td><td></td><td>restart</td><td></td><td></td><td></td></tr><tr><td>进程被强制杀死</td><td></td><td>restart</td><td></td><td>restart</td><td>restart</td><td>restart</td><td></td></tr><tr><td>systemd操作超时</td><td></td><td>restart</td><td></td><td>restart</td><td>restart</td><td></td><td></td></tr><tr><td>看门狗超时</td><td></td><td>restart</td><td></td><td>restart</td><td>restart</td><td></td><td>restart</td></tr></tbody></table></div><blockquote><ul><li>正常退出：退出码为”0”， 或者进程收到 <code>SIGHUP</code>, <code>SIGINT</code>, <code>SIGTERM</code>, <code>SIGPIPE</code> 信号之一，并且退出码符合 <code>SuccessExitStatus=</code> 的设置</li><li>异常退出：包括退出码不为“0”、进程被强制杀死、systemd操作超时、看门狗超时</li></ul></blockquote><ul><li><code>RestartSec</code>：配合 <code>Restart</code> 使用，重新启动服务之前的睡眠时间，设置如异常退出后，等待多少秒再次启动，默认 100ms</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                     |----RestartSec------|</span><br><span class="line">---------|-----------|--------------------|------------|----------</span><br><span class="line"> running    stopping    stopped             starting     running</span><br></pre></td></tr></table></figure><ul><li><code>StartLimitInterval</code>、<code>StartLimitBurst</code>：重启限制次数，在 <code>StartLimitBurst=</code> 时间内尝试重启超过 <code>StartLimitInterval=</code> 次则不再重启，默认为 10s 内 5 次，如需无限制，则设置 <code>StartLimitInterval=0</code></li></ul><p><strong>重启命令</strong></p><ul><li><code>ExecReload</code>字段：重启服务时执行的命令</li></ul><h3 id="Install-区块"><a href="#Install-区块" class="headerlink" title="Install 区块"></a>Install 区块</h3><p>定义服务单元的安装和启用选项，指定如何将服务单元与目标（如启动目标或其他服务）关联。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><ul><li><p><code>WantedBy</code>：定义服务应该被哪些目标“需要”，这意味着在这些目标启动时，该服务也会被自动启动</p><ul><li><p>示例说明服务所在 target 是 multi-user.target，这个设置很通用且重要</p></li><li><p>在 enable 这个服务后，在 <code>/etc/systemd/system/multi-user.target.wants/</code> 的指定目录中创建了一个指向 <code>/usr/lib/systemd/system/XXX.service</code> 的符号链接</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># systemctl enable nginx</span></span><br><span class="line">Created symlink /etc/systemd/system/multi<span class="literal">-user</span>.target.wants/nginx.service → /usr/lib/systemd/system/nginx.service.</span><br></pre></td></tr></table></figure></li><li><p>相当于为 <code>multi-user.target</code> 添加了 <code>Wants=nginx</code> 配置</p></li><li><p>当系统启动时, <code>multi-user.target</code> 启动，<code>nginx.service</code> 单元也会被启动</p></li></ul></li><li><p><code>RequiredBy</code>：类似于 <code>WantedBy</code>，但表示更强的依赖关系，如果目标启动失败，相关服务也不会启动</p></li><li><p><code>Alias</code>：当前 Unit 的别名</p></li><li><p><code>Also</code>：当前 Unit 启用（enable）或禁用（disable）时，会被同时（enable）或禁用（disable）的其他 Unit</p></li></ul><h2 id="配置路径"><a href="#配置路径" class="headerlink" title="配置路径"></a>配置路径</h2><p>配置文件存放在下面地址：</p><ul><li>系统级目录：<code>/lib/systemd/system/</code><ul><li>Linux 系统提供的默认 unit 配置文件的存放位置</li></ul></li><li>用户级目录：<code>~/.config/systemd/user/</code><ul><li>用户级的 unit 配置文件，允许普通用户定义和管理自己的服务和任务。</li></ul></li><li>本地配置目录：<code>/etc/systemd/system/</code><ul><li>本地的 unit 配置文件，用户可以在这里创建或修改 unit 文件。</li></ul></li></ul><p>优先级顺序：</p><ol><li><code>/etc/systemd/system/</code>（本地配置目录，最高优先级）</li><li><code>/run/systemd/system/</code>（临时配置，通常在运行时创建）</li><li><code>/lib/systemd/system/</code>（默认系统提供的配置）</li></ol><p>优先级从高到低，如在高低优先级的目录下有同名 unit，则采用高优先级中的配置。</p><h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><p>systemd 由一组系统命令组成，用来控制系统的方方面面。</p><h2 id="systemctl"><a href="#systemctl" class="headerlink" title="systemctl"></a>systemctl</h2><p>参考链接：<a href="https://manpages.ubuntu.com/manpages/focal/zh_CN/man1/systemctl.1.html" target="_blank" rel="noopener">manpages</a>、<code>man systemctl</code></p><p><code>systemctl</code> 是 systemd 的主命令，用于控制 systemd 系统与服务。</p><ul><li>命令格式：<code>systemctl [OPTIONS...] COMMAND [UNIT...]</code></li></ul><h3 id="系统命令"><a href="#系统命令" class="headerlink" title="系统命令"></a>系统命令</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出 systemd 所有单位</span></span><br><span class="line">systemctl list<span class="literal">-units</span></span><br><span class="line"><span class="comment"># 通过 --type= 筛选出 unit 类型</span></span><br><span class="line">systemctl list<span class="literal">-units</span> -<span class="literal">-type</span>=service</span><br><span class="line"><span class="comment"># 通过 --state= 筛选出 unit 类型</span></span><br><span class="line">systemctl list<span class="literal">-units</span> -<span class="literal">-state</span>=running</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出 systemd 所有单元和状态</span></span><br><span class="line">systemctl list<span class="literal">-unit</span><span class="literal">-files</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已加载的套接字(socket)单元</span></span><br><span class="line">systemctl list<span class="literal">-sockets</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已加载的定时器(timer)单元</span></span><br><span class="line">systemctl list<span class="literal">-timers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载服务配置</span></span><br><span class="line">systemctl daemon<span class="literal">-reload</span></span><br></pre></td></tr></table></figure><h3 id="单-Unit-命令"><a href="#单-Unit-命令" class="headerlink" title="单 Unit 命令"></a>单 Unit 命令</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">systemctl status [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl start [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">systemctl stop [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl restart [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动服务</span></span><br><span class="line">systemctl enable [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机不自启动服务</span></span><br><span class="line">systemctl disable [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示服务信息</span></span><br><span class="line">systemctl show [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读服务配置文件，等同于 cat 配置文件地址</span></span><br><span class="line">systemctl cat [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑服务配置文件，相比直接 vim，编辑后可自动检查格式</span></span><br><span class="line">systemctl edit [<span class="type">SERVICE</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示指定 unit 的依赖关系</span></span><br><span class="line">systemctl list<span class="literal">-dependencies</span> [<span class="type">UNIT</span>]</span><br></pre></td></tr></table></figure><h2 id="journalctl"><a href="#journalctl" class="headerlink" title="journalctl"></a>journalctl</h2><p>参考链接：<a href="https://manpages.ubuntu.com/manpages/oracular/zh_CN/man1/journalctl.1.html" target="_blank" rel="noopener">manpages</a>、<code>man journalctl</code></p><p><code>journalctl</code> 用来查看 systemd 日志，包括系统日志还有各 unit 日志。</p><ul><li>服务：systemd-journald.service</li><li>命令格式：<code>journalctl [OPTIONS...] [MATCHES...]</code></li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有日志（默认情况下 ，只保存本次启动的日志）</span></span><br><span class="line">journalctl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示尾部指定行数的日志</span></span><br><span class="line">journalctl <span class="literal">-n</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时滚动显示最新日志</span></span><br><span class="line">journalctl <span class="operator">-f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核日志（不显示应用日志）</span></span><br><span class="line">journalctl <span class="literal">-k</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统本次启动的日志</span></span><br><span class="line">journalctl <span class="literal">-b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看上一次启动的日志</span></span><br><span class="line">journalctl <span class="literal">-b</span> <span class="literal">-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定时间的日志</span></span><br><span class="line">journalctl -<span class="literal">-since</span>=<span class="string">"2012-10-30 18:17:16"</span></span><br><span class="line">journalctl -<span class="literal">-since</span> <span class="string">"20 min ago"</span></span><br><span class="line">journalctl -<span class="literal">-since</span> yesterday</span><br><span class="line">journalctl -<span class="literal">-since</span> <span class="string">"2015-01-10"</span> -<span class="literal">-until</span> <span class="string">"2015-01-11 03:00"</span></span><br><span class="line">journalctl -<span class="literal">-since</span> <span class="number">09</span>:<span class="number">00</span> -<span class="literal">-until</span> <span class="string">"1 hour ago"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定服务的日志</span></span><br><span class="line">journalctl /usr/lib/systemd/systemd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个 Unit 的日志</span></span><br><span class="line">journalctl <span class="literal">-u</span> nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并显示多个 Unit 的日志</span></span><br><span class="line">journalctl <span class="literal">-u</span> nginx.service <span class="literal">-u</span> php<span class="literal">-fpm</span>.service -<span class="literal">-since</span> today</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定进程的日志</span></span><br><span class="line">journalctl _PID=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个路径的脚本的日志</span></span><br><span class="line">journalctl /usr/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定用户的日志</span></span><br><span class="line">journalctl _UID=<span class="number">33</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定优先级（及其以上级别）的日志，共有8级</span></span><br><span class="line"><span class="comment"># 0: emerg</span></span><br><span class="line"><span class="comment"># 1: alert</span></span><br><span class="line"><span class="comment"># 2: crit</span></span><br><span class="line"><span class="comment"># 3: err</span></span><br><span class="line"><span class="comment"># 4: warning</span></span><br><span class="line"><span class="comment"># 5: notice</span></span><br><span class="line"><span class="comment"># 6: info</span></span><br><span class="line"><span class="comment"># 7: debug</span></span><br><span class="line">journalctl <span class="literal">-p</span> err <span class="literal">-b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志默认分页输出，--no-pager 改为正常的标准输出</span></span><br><span class="line">journalctl -<span class="literal">-no</span><span class="literal">-pager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以 JSON 格式（单行）输出</span></span><br><span class="line">journalctl <span class="literal">-b</span> <span class="literal">-u</span> nginx.service <span class="literal">-o</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以 JSON 格式（多行）输出，可读性更好</span></span><br><span class="line">journalctl <span class="literal">-b</span> <span class="literal">-u</span> nginx.service <span class="literal">-o</span> json<span class="literal">-pretty</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示日志占据的硬盘空间</span></span><br><span class="line">journalctl -<span class="literal">-disk</span><span class="literal">-usage</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定日志文件占据的最大空间</span></span><br><span class="line">journalctl -<span class="literal">-vacuum</span><span class="literal">-size</span>=<span class="number">1</span>G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定日志文件保存多久</span></span><br><span class="line">journalctl -<span class="literal">-vacuum</span><span class="literal">-time</span>=<span class="number">1</span>years</span><br></pre></td></tr></table></figure><h2 id="loginctl"><a href="#loginctl" class="headerlink" title="loginctl"></a>loginctl</h2><p>参考链接：<a href="https://manpages.ubuntu.com/manpages/focal/zh_CN/man1/loginctl.1.html" target="_blank" rel="noopener">manpages</a>、<code>man loginctl</code></p><p><code>loginctl</code>命令用来控制 systemd 登录管理器（systemd-logind.service）。</p><ul><li>服务：systemd-logind.service</li><li>命令格式：<code>loginctl [OPTIONS...] {COMMAND} [NAME...]</code></li></ul><p>COMMAND 分为三种类型：用户、会话和席位</p><blockquote><h3 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h3><p>用户是操作系统中进行交互和操作的实体。在Linux中，每个用户都有一个唯一的用户名和用户ID（UID）。用户可以是普通用户、超级用户（root）等，拥有不同的权限。</p><h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>会话是用户与系统之间的交互过程。当用户登录到Linux系统时，会创建一个会话。会话包含用户的环境设置、运行的程序、打开的文件等。一个用户可以同时拥有多个会话，例如在不同的终端或远程登录时。</p><h3 id="席位"><a href="#席位" class="headerlink" title="席位"></a>席位</h3><p>席位（TTY或终端）是用户与系统之间交互的接口。在Linux中，每个物理或虚拟终端都被称为一个席位。用户可以通过这些席位输入命令并接收输出。现代Linux系统通常支持多个席位，例如通过虚拟终端（tty）或图形界面（X Window System）。</p></blockquote><ul><li><p><strong>用户命令</strong></p><ul><li><p>列出当前登录用户 <code>list-users</code></p> <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl list-users</span></span><br><span class="line"> UID USER</span><br><span class="line">   <span class="number">0</span> root</span><br><span class="line"><span class="number">1000</span> guoyi</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> users listed.</span><br></pre></td></tr></table></figure></li><li><p>显示用户状态<code>user-status [USER...]</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl user-status root</span></span><br><span class="line">root (<span class="number">0</span>)</span><br><span class="line">           Since: Sat <span class="number">2024</span><span class="literal">-10</span><span class="literal">-05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">47</span> PDT; <span class="number">9</span>h ago</span><br><span class="line">           State: active</span><br><span class="line">        Sessions: <span class="number">321</span> *<span class="number">304</span></span><br><span class="line">          Linger: no</span><br><span class="line">            Unit: user<span class="literal">-0</span>.slice</span><br><span class="line">                  ├─session<span class="literal">-304</span>.scope</span><br><span class="line">                  │ ├─<span class="number">57001</span> sshd: root@pts/<span class="number">1</span></span><br><span class="line">                  │ ├─<span class="number">57094</span> <span class="literal">-bash</span></span><br><span class="line">                  │ ├─<span class="number">58718</span> loginctl user<span class="literal">-status</span> root</span><br><span class="line">                  │ └─<span class="number">58719</span> pager</span><br><span class="line">                  ├─session<span class="literal">-321</span>.scope</span><br><span class="line">                  │ ├─<span class="number">58486</span> sshd: root@pts/<span class="number">2</span></span><br><span class="line">                  │ └─<span class="number">58572</span> <span class="literal">-bash</span></span><br><span class="line">                  └─user@<span class="number">0</span>.service</span><br><span class="line">                    └─init.scope</span><br><span class="line">                      ├─<span class="number">57004</span> /lib/systemd/systemd -<span class="literal">-user</span></span><br><span class="line">                      └─<span class="number">57005</span> (sd<span class="literal">-pam</span>)</span><br><span class="line"></span><br><span class="line">Oct <span class="number">05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">48</span> ubuntu systemd[<span class="number">57004</span>]: Condition check resulted <span class="keyword">in</span> Sound System being sk&gt;</span><br><span class="line">Oct <span class="number">05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">48</span> ubuntu systemd[<span class="number">57004</span>]: Listening on REST API socket <span class="keyword">for</span> snapd user sessi&gt;</span><br><span class="line">Oct <span class="number">05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">48</span> ubuntu systemd[<span class="number">57004</span>]: Listening on D<span class="literal">-Bus</span> User Message Bus Socket.</span><br><span class="line">Oct <span class="number">05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">48</span> ubuntu systemd[<span class="number">57004</span>]: Reached target Sockets.</span><br><span class="line">Oct <span class="number">05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">48</span> ubuntu systemd[<span class="number">57004</span>]: Reached target Basic System.</span><br><span class="line">Oct <span class="number">05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">48</span> ubuntu systemd[<span class="number">57004</span>]: Condition check resulted <span class="keyword">in</span> Sound Service being s</span><br></pre></td></tr></table></figure></li><li><p>显示用户各属性<code>show-user [USER...]</code>，可以用 <code>--all</code> 选项查看缺省空置，使用 <code>--property=</code> 查看特定属性</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl show-user root</span></span><br><span class="line">UID=<span class="number">0</span></span><br><span class="line">GID=<span class="number">0</span></span><br><span class="line">Name=root</span><br><span class="line">Timestamp=Sat <span class="number">2024</span><span class="literal">-10</span><span class="literal">-05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">47</span> PDT</span><br><span class="line">TimestampMonotonic=<span class="number">574471117888</span></span><br><span class="line">RuntimePath=/run/user/<span class="number">0</span></span><br><span class="line">Service=user@<span class="number">0</span>.service</span><br><span class="line">Slice=user<span class="literal">-0</span>.slice</span><br><span class="line">Display=<span class="number">304</span></span><br><span class="line">State=active</span><br><span class="line">Sessions=<span class="number">321</span> <span class="number">304</span></span><br><span class="line">IdleHint=no</span><br><span class="line">IdleSinceHint=<span class="number">0</span></span><br><span class="line">IdleSinceHintMonotonic=<span class="number">0</span></span><br><span class="line">Linger=no</span><br></pre></td></tr></table></figure></li><li><p>等等</p></li></ul></li><li><p><strong>会话命令</strong></p><ul><li><p>列出当前所有会话 <code>list-sessions</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl list-sessions</span></span><br><span class="line">SESSION  UID USER  SEAT  TTY</span><br><span class="line">      <span class="number">2</span> <span class="number">1000</span> guoyi seat0 tty2</span><br><span class="line">    <span class="number">304</span>    <span class="number">0</span> root</span><br><span class="line">    <span class="number">321</span>    <span class="number">0</span> root</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> sessions listed.</span><br></pre></td></tr></table></figure></li><li><p>显示简洁的会话状态信息<code>session-status [ID...]</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl session-status 304</span></span><br><span class="line"><span class="number">304</span> - root (<span class="number">0</span>)</span><br><span class="line">           Since: Sat <span class="number">2024</span><span class="literal">-10</span><span class="literal">-05</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">47</span> PDT; <span class="number">9</span>h ago</span><br><span class="line">          Leader: <span class="number">57001</span> (sshd)</span><br><span class="line">          Remote: <span class="number">192.168</span>.<span class="number">45.1</span></span><br><span class="line">         Service: sshd; type tty; <span class="class"><span class="keyword">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class">           <span class="title">State</span>: <span class="title">active</span></span></span><br><span class="line"><span class="class">            <span class="title">Unit</span>: <span class="title">session</span>-304.<span class="title">scope</span></span></span><br><span class="line"><span class="class">                  ├─57001 <span class="title">sshd</span>: <span class="title">root</span>@<span class="title">pts</span>/1</span></span><br><span class="line"><span class="class">                  ├─57094 -<span class="title">bash</span></span></span><br><span class="line"><span class="class">                  ├─58744 <span class="title">loginctl</span> <span class="title">session</span>-<span class="title">status</span> 304</span></span><br><span class="line"><span class="class">                  └─58745 <span class="title">pager</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">Oct</span> 05 01:40:48 <span class="title">ubuntu</span> <span class="title">systemd</span>[1]: <span class="title">Started</span> <span class="title">Session</span> 304 <span class="title">of</span> <span class="title">user</span> <span class="title">root</span>.</span></span><br></pre></td></tr></table></figure></li><li><p>显示会话的各项属性值<code>show-session [ID...]</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl show-session 321</span></span><br><span class="line">Id=<span class="number">321</span></span><br><span class="line">User=<span class="number">0</span></span><br><span class="line">Name=root</span><br><span class="line">Timestamp=Sat <span class="number">2024</span><span class="literal">-10</span><span class="literal">-05</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">06</span> PDT</span><br><span class="line">TimestampMonotonic=<span class="number">606290337700</span></span><br><span class="line">VTNr=<span class="number">0</span></span><br><span class="line">Remote=yes</span><br><span class="line">RemoteHost=<span class="number">192.168</span>.<span class="number">45.1</span></span><br><span class="line">Service=sshd</span><br><span class="line">Scope=session<span class="literal">-321</span>.scope</span><br><span class="line">Leader=<span class="number">58486</span></span><br><span class="line">Audit=<span class="number">321</span></span><br><span class="line">Type=tty</span><br><span class="line"><span class="class"><span class="keyword">Class</span>=<span class="title">user</span></span></span><br><span class="line"><span class="class"><span class="title">Active</span>=<span class="title">yes</span></span></span><br><span class="line"><span class="class"><span class="title">State</span>=<span class="title">active</span></span></span><br><span class="line"><span class="class"><span class="title">IdleHint</span>=<span class="title">no</span></span></span><br><span class="line"><span class="class"><span class="title">IdleSinceHint</span>=0</span></span><br><span class="line"><span class="class"><span class="title">IdleSinceHintMonotonic</span>=0</span></span><br><span class="line"><span class="class"><span class="title">LockedHint</span>=<span class="title">no</span></span></span><br></pre></td></tr></table></figure></li><li><p>等等</p></li></ul></li><li><p><strong>席位命令</strong></p><ul><li><p>显示所有可用席位<code>list-seats</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># loginctl list-seats</span></span><br><span class="line">SEAT</span><br><span class="line">seat0</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> seats listed.</span><br></pre></td></tr></table></figure></li><li><p>等等</p></li></ul></li></ul><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://systemd.io" target="_blank" rel="noopener">官方文档</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;systemd 是 Linux 的系统和服务管理器。作为系统启动的第一个进程，初始化系统并且管理其他用户服务。&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://gy23333.github.io/categories/Linux/"/>
    
    
    <category term="systemd" scheme="https://gy23333.github.io/tags/systemd/"/>
    
    <category term="Linux" scheme="https://gy23333.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Docker</title>
    <link href="https://gy23333.github.io/2024/09/19/Docker/"/>
    <id>https://gy23333.github.io/2024/09/19/Docker/</id>
    <published>2024-09-19T05:48:28.000Z</published>
    <updated>2025-01-15T14:29:58.382Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>基于 Go 的开源应用容器引擎 Docker</p><a id="more"></a><h1 id="快速了解-Docker"><a href="#快速了解-Docker" class="headerlink" title="快速了解 Docker"></a>快速了解 Docker</h1><p>快速了解 docker 的小视频</p><p>【docker是什么？和kubernetes(k8s)是什么关系？-哔哩哔哩】 </p><iframe src="//player.bilibili.com/player.html?isOutside=true&aid=1102796777&bvid=BV1aA4m1w7Ew&cid=1501859959&p=1&autoplay=0" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe><ul><li>Docker 是一款能将程序和环境一起打包并运行的工具软件。Docker 作为中间层，使得应用和机器基础架构分离，从而实现不同架构下的快速交付部署。</li><li>程序和环境打包构建成一个容器镜像文件，根据 Dockerfile 构建出容器镜像，Dockerfile 中设置包括指定环境的基础镜像（如 ubuntu/centos、python/go 等等）以及后续需执行的命令（比如安装依赖、运行服务等）。</li><li>部署环境部署容器镜像，就会在 Linux 上以一个进程的形式运行该 docker 容器，利用操作系统的用户空间构建出应用所需的环境，运行相应服务。</li><li>Docker Registy：相当于 docker 镜像的代码仓，也就是镜像仓，可以将 docker 镜像推到 Registy，部署环境再从 Registy 拉取镜像。</li><li>Docker Compose：一整套服务经常包含多个 docker 镜像部署到单节点，这时候就可以使用 Docker Compose 来部署，通过 yaml 文件呢规定各个 docker 镜像间的部署顺序与其他部署配置信息。</li><li>Docker Swarm：解决一整套服务在多个节点间的部署问题，如迁移、扩缩容。</li><li>k8s：与 Docker Swarm 类似，也是解决一整套服务在多个节点间的部署问题，如迁移、扩缩容。</li></ul><h1 id="虚拟化过程"><a href="#虚拟化过程" class="headerlink" title="虚拟化过程"></a>虚拟化过程</h1><h2 id="物理机"><a href="#物理机" class="headerlink" title="物理机"></a>物理机</h2><p>物理机存在的痛点：</p><ul><li>各个应用会共享依赖库，所以有可能存在不同应用依赖有冲突的问题，比如需要同一个依赖的不同版本</li><li>低使用率，可能仅有几个应用在运行，却得占用一整台物理机</li><li>爆炸半径大，比如改变一个应用的依赖，可以会导致另一应用变得不可用</li><li>开关机慢</li><li>创建和搭建物理机慢</li></ul><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241013193557973.png" alt="image-20241013193557973" style="zoom:40%;" /></p><h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p>物理机上的 Hypervisor 会从物理机分离出独立的资源池，在这个资源池中生成虚拟化硬件以及与物理机相同的上方结构。</p><p>Hypervisor 分为两类：</p><ul><li>Type 1：不依赖物理机上的 OS，比如 VMware、Hyper-V</li><li>Type 2：依赖物理机上的 OS，比如 Virtual Box</li></ul><p>虚拟机一定程度上缓解了物理机的问题。</p><ul><li>应用运行在不同的虚拟机上，实现相互隔离，解决了依赖冲突问题</li><li>可以根据需要分配相应的规格，提高使用率</li><li>减小了爆炸半径</li><li>开关机变为分钟级</li><li>最大的好处：可以快速构建虚拟机</li></ul><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241014005509938.png" alt="image-20241014005509938" style="zoom:40%;" /></p><h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><p>容器的载体可以是物理机也可以是虚拟机，和虚拟机的 Hypervisor 相对，容器通过 Container Runtime 控制。</p><p>容器与虚拟机的最大不同点：</p><ul><li>虚拟机复制了一份 Linux 内核</li><li>容器并不存在内核，而是与载体的 OS 共用一个内核</li></ul><p>容器的好处：</p><ul><li>无依赖冲突问题</li><li>进一步提高了资源利用率。虚拟机还需要构造一套 OS，而容器可以直接依赖于宿主机的 OS</li><li>进一步减小了爆炸半径。每个容器所占的资源相对更少了，爆炸半径也就相对减小。不过其实隔离性是不如虚拟机的</li><li>开关容器时间短（秒级）</li><li>极快速部署</li></ul><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241014015955548.png" alt="image-20241014015955548" style="zoom:40%;" /></p><h2 id="日常结构"><a href="#日常结构" class="headerlink" title="日常结构"></a>日常结构</h2><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/image-20241015021636441.png" alt="image-20241015021636441" style="zoom:60%;" /></p><h1 id="Docker-架构"><a href="#Docker-架构" class="headerlink" title="Docker 架构"></a>Docker 架构</h1><p>Docker 采用 client-server 架构，由 Docker Client 发出指令，命令 Docker daemon 构建、运行、分发 Docker containers。Docker Client 和 Docker daemon 可以运行在同一个节点，也可以用 Docker Client 控制远程的 Docker daemon。</p><p><img src="https://gy-pic.oss-cn-hangzhou.aliyuncs.com/docker-architecture.webp" alt=""></p><h2 id="镜像-Image"><a href="#镜像-Image" class="headerlink" title="镜像 Image"></a>镜像 Image</h2><p>容器镜像是一个由程序和环境构建出的标准包，包括了用来运行容器所需的文件、二进制文件、库以及配置。</p><h2 id="容器-Container"><a href="#容器-Container" class="headerlink" title="容器 Container"></a>容器 Container</h2><h1 id="Ubuntu-中安装-Docker-Engine"><a href="#Ubuntu-中安装-Docker-Engine" class="headerlink" title="Ubuntu 中安装 Docker Engine"></a>Ubuntu 中安装 Docker Engine</h1><p><a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener">https://docs.docker.com/engine/install/ubuntu/</a></p><ol><li><p>卸载老版本</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pkg <span class="keyword">in</span> docker.io docker<span class="literal">-doc</span> docker<span class="literal">-compose</span> docker<span class="literal">-compose</span><span class="literal">-v2</span> podman<span class="literal">-docker</span> containerd runc; <span class="keyword">do</span> sudo apt<span class="literal">-get</span> remove <span class="variable">$pkg</span>; done</span><br></pre></td></tr></table></figure></li><li><p>更新 Ubuntu 源列表</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt<span class="literal">-get</span> update</span><br></pre></td></tr></table></figure></li><li><p>安装 docker 依赖包</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt<span class="literal">-get</span> install ca<span class="literal">-certificates</span> curl</span><br></pre></td></tr></table></figure></li><li><p>添加 docker 官方 GPG 密钥</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">install <span class="literal">-m</span> <span class="number">0755</span> <span class="literal">-d</span> /etc/apt/keyrings</span><br><span class="line">curl <span class="literal">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="literal">-o</span> /etc/apt/keyrings/docker.asc</span><br><span class="line">chmod a+r /etc/apt/keyrings/docker.asc</span><br></pre></td></tr></table></figure></li><li><p>添加 docker 官方库</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo \</span><br><span class="line">  <span class="string">"deb [arch=<span class="variable">$</span>(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$</span>(. /etc/os-release &amp;&amp; echo "</span><span class="variable">$VERSION_CODENAME</span><span class="string">") stable"</span> | \</span><br><span class="line">  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure></li><li><p>更新 Ubuntu 源列表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure></li><li><p>安装 docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure></li><li><p>查看 docker 服务运行状态</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure></li></ol><h1 id="配置国内镜像"><a href="#配置国内镜像" class="headerlink" title="配置国内镜像"></a>配置国内镜像</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [</span><br><span class="line">        &quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;,</span><br><span class="line">        &quot;https:&#x2F;&#x2F;docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">        &quot;https:&#x2F;&#x2F;hub-mirror.c.163.com&quot;,</span><br><span class="line">        &quot;https:&#x2F;&#x2F;mirror.baidubce.com&quot;,</span><br><span class="line">        &quot;https:&#x2F;&#x2F;ccr.ccs.tencentyun.com&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2404:&#x2F;home&#x2F;guoyi# s</span><br><span class="line">...</span><br><span class="line"> Registry Mirrors:</span><br><span class="line">  https:&#x2F;&#x2F;registry.docker-cn.com&#x2F;</span><br><span class="line">  https:&#x2F;&#x2F;docker.mirrors.ustc.edu.cn&#x2F;</span><br><span class="line">  https:&#x2F;&#x2F;hub-mirror.c.163.com&#x2F;</span><br><span class="line">  https:&#x2F;&#x2F;mirror.baidubce.com&#x2F;</span><br><span class="line">  https:&#x2F;&#x2F;ccr.ccs.tencentyun.com&#x2F;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="Docker-从构建到部署"><a href="#Docker-从构建到部署" class="headerlink" title="Docker 从构建到部署"></a>Docker 从构建到部署</h1><h2 id="Docker-镜像构建"><a href="#Docker-镜像构建" class="headerlink" title="Docker 镜像构建"></a>Docker 镜像构建</h2><h2 id="Docker-镜像仓"><a href="#Docker-镜像仓" class="headerlink" title="Docker 镜像仓"></a>Docker 镜像仓</h2><h2 id="Docker-容器部署"><a href="#Docker-容器部署" class="headerlink" title="Docker 容器部署"></a>Docker 容器部署</h2><h1 id="Docker-命令"><a href="#Docker-命令" class="headerlink" title="Docker 命令"></a>Docker 命令</h1><p>查看正在运行的容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>查看所有容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><p>开启容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start &lt;CONTAINER ID&gt;</span><br></pre></td></tr></table></figure><p>停止容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop &lt;CONTAINER ID&gt;</span><br></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it &lt;CONTAINER ID&gt; &lt;CLI&gt;</span><br></pre></td></tr></table></figure><h1 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h1><h1 id="Docker-Swarm-与-k8s"><a href="#Docker-Swarm-与-k8s" class="headerlink" title="Docker Swarm 与 k8s"></a>Docker Swarm 与 k8s</h1><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.docker.com" target="_blank" rel="noopener">docker 官网</a></li><li><a href="https://www.youtube.com/watch?v=RqTEHSBrYFw" target="_blank" rel="noopener">https://www.youtube.com/watch?v=RqTEHSBrYFw</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;基于 Go 的开源应用容器引擎 Docker&lt;/p&gt;</summary>
    
    
    
    <category term="Docker" scheme="https://gy23333.github.io/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://gy23333.github.io/tags/Docker/"/>
    
  </entry>
  
</feed>
